<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Social App Pro</title>

<style>
body{
 font-family:system-ui;
 background:#f3f4f6;
 padding:20px;
}
.card{
 background:white;
 padding:16px;
 border-radius:16px;
 margin-top:18px;
 box-shadow:0 4px 20px rgba(0,0,0,.08);
}
button{
 padding:6px 10px;
 border:none;
 border-radius:8px;
 cursor:pointer;
 margin:4px 4px 0 0;
 font-size:13px;
}
.primary{background:#4f46e5;color:white;}
.danger{background:#ef4444;color:white;}
.like{background:#10b981;color:white;}
textarea{
 width:100%;
 padding:8px;
 border-radius:8px;
 margin-top:5px;
}
.image-scroll{
 display:flex;
 overflow-x:auto;
 gap:8px;
 margin-top:10px;
}
.image-scroll img{
 height:200px;
 border-radius:12px;
 object-fit:cover;
}
</style>
</head>
<body>

<h2>ðŸ”¥ Social App Pro</h2>

<div>
<span id="userEmail"></span>
<button id="googleBtn" class="primary">Google</button>
<button id="guestBtn">Guest</button>
<button id="logoutBtn">Logout</button>
</div>

<div class="card">
<textarea id="postInput" placeholder="Write something..."></textarea>
<input type="file" id="imageInput" multiple accept="image/*">
<button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const supabase = window.supabase.createClient(
"https://dgehzagvyrxbnnvgsiff.supabase.co",
"sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let user=null;
let likeLock={};

/* ================= INIT ================= */
async function init(){
 const {data}=await supabase.auth.getUser();
 user=data.user;
 updateUI();

 supabase.auth.onAuthStateChange((e,s)=>{
  user=s?.user||null;
  updateUI();
 });

 loadPosts();
 subscribeRealtime();
}

function updateUI(){
 userEmail.innerText =
 user ? "Logged in: "+(user.email||"Guest") : "Not logged in";
}

googleBtn.onclick=()=>supabase.auth.signInWithOAuth({provider:"google"});
guestBtn.onclick=()=>supabase.auth.signInAnonymously();
logoutBtn.onclick=async()=>{await supabase.auth.signOut();location.reload();};

/* ================= CREATE POST ================= */
postBtn.onclick=async()=>{
 if(!user)return alert("Login first");

 const content=postInput.value.trim();
 const files=imageInput.files;
 if(!content && files.length===0)return alert("Post empty");

 let paths=[];
 for(const f of files){
  const filename=Date.now()+"-"+Math.random()+".jpg";
  await supabase.storage.from("post-images").upload(filename,f);
  paths.push(filename);
 }

 const { data, error } = await supabase
   .from("posts")
   .insert([{content,images:paths,user_id:user.id,username:user.email}])
   .select()
   .single();

 if(data){
   renderPost(data); // show instantly
 }

 postInput.value="";
 imageInput.value="";
};

/* ================= LOAD POSTS ================= */
async function loadPosts(){
 const {data}=await supabase
  .from("posts")
  .select("*")
  .order("created_at",{ascending:false});

 feed.innerHTML="";
 data?.forEach(renderPost);
}

/* ================= RENDER ================= */
async function renderPost(post){

 if(document.getElementById("post-"+post.id))return;

 let imagesHTML="";
 if(post.images?.length){
  imagesHTML=`<div class="image-scroll">`;
  post.images.forEach(file=>{
   const {data}=supabase.storage.from("post-images").getPublicUrl(file);
   imagesHTML+=`<img src="${data.publicUrl}">`;
  });
  imagesHTML+=`</div>`;
 }

 const {count}=await supabase
  .from("likes")
  .select("*",{count:"exact",head:true})
  .eq("post_id",post.id);

 const div=document.createElement("div");
 div.className="card";
 div.id="post-"+post.id;

 div.innerHTML=`
 <b>${post.username||"User"}</b>
 <div>${post.content||""}</div>
 ${imagesHTML}
 <div>
  <button class="like" id="like-${post.id}">
   Like (${count||0})
  </button>
  ${user && user.id===post.user_id ?
   `<button class="danger" onclick="deletePost('${post.id}')">Delete</button>`
   :""}
 </div>
 `;

 feed.prepend(div);

 document.getElementById("like-"+post.id)
  .onclick=()=>toggleLike(post.id);
}

/* ================= DELETE POST ================= */
window.deletePost=async(postId)=>{
 if(!user)return;

 await supabase.from("posts")
  .delete()
  .eq("id",postId)
  .eq("user_id",user.id);

 const el=document.getElementById("post-"+postId);
 if(el) el.remove();
};

/* ================= LIKE SYSTEM ================= */
async function toggleLike(postId){

 if(!user) return;
 if(likeLock[postId]) return;

 likeLock[postId]=true;

 const btn=document.getElementById("like-"+postId);
 let current=parseInt(btn.innerText.match(/\d+/)[0]);

 const { data } = await supabase
   .from("likes")
   .select("id")
   .eq("post_id", postId)
   .eq("user_id", user.id)
   .maybeSingle();

 if (data) {
   btn.innerText=`Like (${Math.max(current-1,0)})`;
   await supabase
     .from("likes")
     .delete()
     .eq("post_id", postId)
     .eq("user_id", user.id);
 } else {
   btn.innerText=`Like (${current+1})`;
   await supabase
     .from("likes")
     .insert([{ post_id: postId, user_id: user.id }]);
 }

 likeLock[postId]=false;
}

/* ================= REALTIME ================= */
function subscribeRealtime(){

 supabase
  .channel('likes-live')
  .on(
    'postgres_changes',
    { event:'*', schema:'public', table:'likes' },
    async payload => {

      const postId =
        payload.new?.post_id ||
        payload.old?.post_id;

      if(!postId) return;

      const btn=document.getElementById("like-"+postId);
      if(!btn) return;

      const {count}=await supabase
        .from("likes")
        .select("*",{count:"exact",head:true})
        .eq("post_id",postId);

      btn.innerText=`Like (${count||0})`;
    }
  )
  .subscribe();
}

init();
});
</script>
</body>
</html>