<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{
  font-family: system-ui, -apple-system;
  background:#f2f2f2;
  padding:20px;
  transition:.3s;
}
.dark{background:#0f0f0f;color:white;}
.card{
  background:white;
  padding:16px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}
.dark .card{background:#1c1c1c;}
button{
  padding:6px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:#4f46e5;color:white;}
.like-btn{background:#eee;}
.liked{background:#ef4444;color:white;}
textarea{width:100%;border-radius:8px;padding:8px;}
img{max-width:100%;border-radius:10px;margin-top:8px;}
.small{font-size:12px;opacity:.6;}
.comment-box{margin-top:10px;padding-left:10px;border-left:2px solid #ddd;}
.user-bar{margin-bottom:15px;}
</style>
</head>
<body>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div class="user-bar">
  <span id="userEmail"></span>
  <button id="googleBtn" class="primary">Google Login</button>
  <button id="guestBtn">Guest Login</button>
  <button id="logoutBtn">Logout</button>
  <button id="darkBtn">ðŸŒ™</button>
</div>

<div class="card">
  <textarea id="postInput" placeholder="Write something..."></textarea>
  <input type="file" id="imageInput" multiple accept="image/*">
  <button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const supabase = window.supabase.createClient(
"https://dgehzagvyrxbnnvgsiff.supabase.co",
"sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let user=null;

/* ================= TIME ================= */
function timeAgo(date){
  const s=Math.floor((Date.now()-new Date(date))/1000);
  if(s<60)return"Just now";
  if(s<3600)return Math.floor(s/60)+"m ago";
  if(s<86400)return Math.floor(s/3600)+"h ago";
  return Math.floor(s/86400)+"d ago";
}

/* ================= AUTH ================= */

async function init(){
  const {data}=await supabase.auth.getUser();
  user=data.user;
  updateUserUI();
  loadInitialPosts();
  subscribeRealtime();
}

function updateUserUI(){
  document.getElementById("userEmail").innerText =
    user ? "Logged in: "+(user.email || "Guest") : "Not logged in";
}

document.getElementById("googleBtn").onclick=
()=>supabase.auth.signInWithOAuth({provider:"google"});

document.getElementById("guestBtn").onclick=
async()=>{
  const {data}=await supabase.auth.signInAnonymously();
  user=data.user;
  updateUserUI();
};

document.getElementById("logoutBtn").onclick=
async()=>{
  await supabase.auth.signOut();
  location.reload();
};

/* ================= IMAGE COMPRESSION ================= */

async function compressImage(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.readAsDataURL(file);
    r.onload=e=>{
      const img=new Image();
      img.src=e.target.result;
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        const MAX=1080;
        let w=img.width,h=img.height;
        if(w>MAX){h=h*(MAX/w);w=MAX;}
        canvas.width=w;canvas.height=h;
        canvas.getContext("2d").drawImage(img,0,0,w,h);
        canvas.toBlob(b=>res(b),"image/jpeg",0.7);
      }
    }
  })
}

/* ================= POST CREATE ================= */

document.getElementById("postBtn").onclick=async()=>{

  if(!user)return alert("Login first");

  const content=document.getElementById("postInput").value;
  const files=document.getElementById("imageInput").files;
  let urls=[];

  for(const f of files){
    const blob=await compressImage(f);
    const name=Date.now()+"-"+Math.random()+".jpg";
    await supabase.storage.from("post-images").upload(name,blob);
    const {data}=supabase.storage.from("post-images").getPublicUrl(name);
    urls.push(data.publicUrl);
  }

  await supabase.from("posts").insert([{
    content,images:urls,user_id:user.id,username:user.email
  }]);

  document.getElementById("postInput").value="";
  document.getElementById("imageInput").value="";
};

/* ================= RENDER ================= */

function renderPost(post){

  if(document.getElementById("post-"+post.id))return;

  const div=document.createElement("div");
  div.className="card";
  div.id="post-"+post.id;

  let imgs="";
  if(post.images){
    post.images.forEach(u=>imgs+=`<img src="${u}">`);
  }

  div.innerHTML=`
    <b>${post.username||"User"}</b>
    <div class="small">${timeAgo(post.created_at)}</div>
    <div id="content-${post.id}">${post.content||""}</div>
    ${imgs}
    <br>
    <button class="like-btn" id="like-${post.id}">Like</button>
    <span id="like-count-${post.id}">0</span>
    <div id="comments-${post.id}"></div>
    <textarea id="comment-input-${post.id}" placeholder="Comment..."></textarea>
    <button onclick="addComment('${post.id}')">Send</button>
  `;

  document.getElementById("feed").prepend(div);

  initLike(post.id);
  loadComments(post.id);
}

/* ================= LIKE (NO FULL RELOAD) ================= */

async function initLike(postId){

  const btn=document.getElementById("like-"+postId);

  const {count}=await supabase.from("likes")
    .select("*",{count:"exact",head:true})
    .eq("post_id",postId)
    .eq("active",true);

  document.getElementById("like-count-"+postId).innerText=count||0;

  btn.onclick=async()=>{
    if(!user)return alert("Login");
    const {data}=await supabase.from("likes")
      .select("*")
      .eq("post_id",postId)
      .eq("user_id",user.id)
      .maybeSingle();

    if(data){
      await supabase.from("likes")
        .update({active:!data.active})
        .eq("id",data.id);
    }else{
      await supabase.from("likes")
        .insert([{post_id:postId,user_id:user.id,active:true}]);
    }
  }
}

/* ================= COMMENTS ================= */

window.addComment=async function(postId){
  if(!user)return alert("Login");
  const input=document.getElementById("comment-input-"+postId);
  if(!input.value)return;
  await supabase.from("comments").insert([{
    post_id:postId,user_id:user.id,
    username:user.email,content:input.value
  }]);
  input.value="";
}

async function loadComments(postId){
  const {data}=await supabase.from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});
  const box=document.getElementById("comments-"+postId);
  box.innerHTML="";
  data.forEach(c=>{
    box.innerHTML+=`
      <div class="comment-box">
        <b>${c.username}</b>
        <span class="small">${timeAgo(c.created_at)}</span>
        <div>${c.content}</div>
      </div>
    `;
  })
}

/* ================= REALTIME ================= */

function subscribeRealtime(){

  supabase.channel("posts")
    .on("postgres_changes",
      {event:"INSERT",schema:"public",table:"posts"},
      p=>renderPost(p.new)
    ).subscribe();

  supabase.channel("likes")
    .on("postgres_changes",
      {event:"*",schema:"public",table:"likes"},
      async p=>{
        const postId=p.new?.post_id||p.old?.post_id;
        const {count}=await supabase.from("likes")
          .select("*",{count:"exact",head:true})
          .eq("post_id",postId)
          .eq("active",true);
        const el=document.getElementById("like-count-"+postId);
        if(el)el.innerText=count||0;
      }
    ).subscribe();

  supabase.channel("comments")
    .on("postgres_changes",
      {event:"*",schema:"public",table:"comments"},
      p=>{
        const postId=p.new?.post_id||p.old?.post_id;
        if(postId)loadComments(postId);
      }
    ).subscribe();
}

/* ================= LOAD INITIAL ================= */

async function loadInitialPosts(){
  const {data}=await supabase.from("posts")
    .select("*")
    .order("created_at",{ascending:false});
  data.forEach(renderPost);
}

/* ================= DARK MODE ================= */

document.getElementById("darkBtn").onclick=
()=>document.body.classList.toggle("dark");

init();

});
</script>
</body>
</html>