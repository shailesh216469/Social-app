<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App vStable</title>

<style>
body{font-family:system-ui;background:#f3f4f6;padding:20px;}
.card{background:white;padding:16px;border-radius:12px;margin-top:18px;box-shadow:0 3px 15px rgba(0,0,0,.06);}
button{padding:6px 10px;border:none;border-radius:8px;cursor:pointer;margin:4px 4px 0 0;font-size:13px;}
.primary{background:#4f46e5;color:white;}
.danger{background:#ef4444;color:white;}
.like{background:#10b981;color:white;}
textarea{width:100%;padding:8px;border-radius:8px;margin-top:5px;}
.image-scroll{display:flex;overflow-x:auto;gap:8px;margin-top:10px;}
.image-scroll img{max-height:220px;border-radius:10px;}
.comment{margin-top:6px;font-size:13px;}
.small{font-size:12px;color:gray;}
</style>
</head>
<body>

<h2>üî• Social App Stable</h2>

<div>
<span id="userEmail"></span>
<button id="googleBtn" class="primary">Google</button>
<button id="guestBtn">Guest</button>
<button id="logoutBtn">Logout</button>
</div>

<div class="card">
<textarea id="postInput" placeholder="Write something..."></textarea>
<input type="file" id="imageInput" multiple accept="image/*">
<button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const supabase = window.supabase.createClient(
"https://dgehzagvyrxbnnvgsiff.supabase.co",
"sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let user=null;

/* TIME FORMAT */
function timeAgo(date){
 const seconds=Math.floor((new Date()-new Date(date))/1000);
 const intervals=[
  {label:"y",sec:31536000},
  {label:"mo",sec:2592000},
  {label:"d",sec:86400},
  {label:"h",sec:3600},
  {label:"m",sec:60}
 ];
 for(const i of intervals){
  const count=Math.floor(seconds/i.sec);
  if(count>0)return count+i.label+" ago";
 }
 return "just now";
}

/* AUTH */
async function init(){
 const {data}=await supabase.auth.getUser();
 user=data.user;
 updateUI();

 supabase.auth.onAuthStateChange((e,s)=>{
  user=s?.user||null;
  updateUI();
 });

 await loadPosts();
 subscribeRealtime();
}

function updateUI(){
 userEmail.innerText =
 user ? "Logged in: "+(user.email||"Guest") : "Not logged in";
}

googleBtn.onclick=()=>supabase.auth.signInWithOAuth({provider:"google"});
guestBtn.onclick=()=>supabase.auth.signInAnonymously();
logoutBtn.onclick=async()=>{await supabase.auth.signOut();location.reload();};

/* CREATE POST */
postBtn.onclick=async()=>{
 if(!user)return alert("Login first");

 const content=postInput.value.trim();
 const files=imageInput.files;
 if(!content && files.length===0)return alert("Post empty");

 let paths=[];
 for(const f of files){
  const filename=Date.now()+"-"+Math.random()+".jpg";
  const {error}=await supabase.storage.from("post-images").upload(filename,f);
  if(!error) paths.push(filename);
 }

 await supabase.from("posts")
  .insert([{content,images:paths,user_id:user.id,username:user.email}]);

 postInput.value="";
 imageInput.value="";
};

/* LOAD POSTS */
async function loadPosts(){
 const {data}=await supabase
  .from("posts")
  .select("*")
  .order("created_at",{ascending:false});

 feed.innerHTML="";
 data?.forEach(renderPost);
}

/* RENDER POST */
async function renderPost(post){

 if(document.getElementById("post-"+post.id))return;

 let imagesHTML="";
 if(post.images?.length){
  imagesHTML=`<div class="image-scroll">`;
  post.images.forEach(file=>{
   const {data}=supabase.storage.from("post-images").getPublicUrl(file);
   imagesHTML+=`<img src="${data.publicUrl}">`;
  });
  imagesHTML+=`</div>`;
 }

 const div=document.createElement("div");
 div.className="card";
 div.id="post-"+post.id;

 const liked=await isLiked(post.id);
 const likeCount=await countLikes(post.id);

 div.innerHTML=`
 <b>${post.username||"User"}</b>
 <div class="small">${timeAgo(post.created_at)}</div>
 <div>${post.content||""}</div>
 ${imagesHTML}

 <div>
  <button class="like" onclick="toggleLike('${post.id}')">
   ${liked?"Unlike":"Like"} (${likeCount})
  </button>

  ${user && user.id===post.user_id ?
   `<button class="danger" onclick="deletePost('${post.id}')">Delete</button>`
   :""}
 </div>

 <div id="comments-${post.id}"></div>
 <textarea id="comment-input-${post.id}" placeholder="Comment..."></textarea>
 <button onclick="addComment('${post.id}')">Send</button>
 `;

 feed.appendChild(div);
 loadComments(post.id);
}

/* DELETE POST (NO STORAGE DELETE) */
window.deletePost=async(postId)=>{

 if(!user) return alert("Login required");

 const { data: post } = await supabase
   .from("posts")
   .select("user_id")
   .eq("id", postId)
   .single();

 if (!post || post.user_id !== user.id) {
   return alert("Not allowed");
 }

 const { error } = await supabase
   .from("posts")
   .delete()
   .eq("id", postId)
   .eq("user_id", user.id);

 if (error) {
   console.error(error);
   return alert("Delete failed");
 }

 document.getElementById("post-" + postId)?.remove();
};

/* LIKE SYSTEM */
async function isLiked(postId){
 if(!user)return false;
 const {data}=await supabase.from("likes")
  .select("*")
  .eq("post_id",postId)
  .eq("user_id",user.id);
 return data.length>0;
}

async function countLikes(postId){
 const {count}=await supabase.from("likes")
  .select("*",{count:"exact",head:true})
  .eq("post_id",postId);
 return count||0;
}

window.toggleLike=async(postId)=>{
 if(!user)return;

 const liked=await isLiked(postId);

 if(liked){
  await supabase.from("likes")
   .delete()
   .eq("post_id",postId)
   .eq("user_id",user.id);
 }else{
  await supabase.from("likes")
   .insert([{post_id:postId,user_id:user.id}]);
 }

 loadPosts();
};

/* COMMENTS */
window.addComment=async(postId)=>{
 if(!user)return;
 const input=document.getElementById("comment-input-"+postId);
 if(!input.value)return;

 await supabase.from("comments")
  .insert([{post_id:postId,user_id:user.id,
    username:user.email,content:input.value}]);

 input.value="";
};

async function loadComments(postId){
 const {data}=await supabase.from("comments")
  .select("*")
  .eq("post_id",postId)
  .order("created_at",{ascending:true});

 const box=document.getElementById("comments-"+postId);
 if(!box)return;
 box.innerHTML="";

 data?.forEach(c=>{
  box.innerHTML+=`
   <div class="comment">
    <b>${c.username}</b> ${timeAgo(c.created_at)} :
    ${c.content}
    ${
     user && user.id===c.user_id
     ? `<button onclick="deleteComment('${c.id}','${postId}')">‚ùå</button>`
     : ""
    }
   </div>
  `;
 });
}

window.deleteComment=async(id,postId)=>{
 await supabase.from("comments")
  .delete()
  .eq("id",id)
  .eq("user_id",user.id);

 loadComments(postId);
};

/* REALTIME */
function subscribeRealtime(){

 supabase.channel("posts")
  .on("postgres_changes",{event:"*",schema:"public",table:"posts"},
   ()=>loadPosts())
  .subscribe();

 supabase.channel("comments")
  .on("postgres_changes",{event:"*",schema:"public",table:"comments"},
   payload=>{
    const id=payload.new?.post_id||payload.old?.post_id;
    if(id)loadComments(id);
   })
  .subscribe();
}

init();
});
</script>
</body>
</html>