<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{font-family:Arial;padding:20px;background:#f4f4f4;transition:0.3s;}
.dark{background:#111;color:white;}
.post{background:white;padding:15px;margin-top:15px;border-radius:8px;}
.dark .post{background:#1e1e1e;}
button{margin-right:5px;margin-top:5px;}
.small{font-size:12px;opacity:0.7;}
.comment-box{margin-top:8px;padding-left:10px;border-left:2px solid #ccc;}
.comment-input{width:100%;margin-top:5px;}
.comment-item{margin-bottom:5px;}
.edit-area{width:100%;margin-top:5px;}
.image-preview img{max-width:100%;margin-top:8px;border-radius:8px;}
.liked{background:red;color:white;}
.not-liked{background:#ddd;}
</style>
</head>
<body>

<button id="darkBtn">üåô Dark Mode</button>
<h2>üî• Ultimate Social App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn">Logout</button>

<hr>

<textarea id="postInput" placeholder="Write something..."></textarea>
<br>
<input type="file" id="imageInput" multiple accept="image/*">
<br>
<button id="postBtn">Post</button>

<hr>
<div id="posts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;

/* ================= TIME ================= */

function timeAgo(dateString){
  const now=new Date();
  const past=new Date(dateString);
  const seconds=Math.floor((now-past)/1000);
  if(seconds<60) return "Just now";
  const minutes=Math.floor(seconds/60);
  if(minutes<60) return minutes+"m ago";
  const hours=Math.floor(minutes/60);
  if(hours<24) return hours+"h ago";
  const days=Math.floor(hours/24);
  if(days<7) return days+"d ago";
  return past.toLocaleDateString();
}

/* ================= IMAGE COMPRESSION ================= */

async function compressImage(file){
  return new Promise((resolve)=>{
    const reader=new FileReader();
    reader.readAsDataURL(file);
    reader.onload=function(event){
      const img=new Image();
      img.src=event.target.result;
      img.onload=function(){
        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");
        const MAX_WIDTH=1080;
        let width=img.width;
        let height=img.height;
        if(width>MAX_WIDTH){
          height=height*(MAX_WIDTH/width);
          width=MAX_WIDTH;
        }
        canvas.width=width;
        canvas.height=height;
        ctx.drawImage(img,0,0,width,height);
        canvas.toBlob(blob=>resolve(blob),"image/jpeg",0.7);
      };
    };
  });
}

async function uploadImages(files){
  const urls=[];
  for(const file of files){
    const compressed=await compressImage(file);
    const fileName=Date.now()+"-"+Math.random().toString(36).substring(2)+".jpg";
    await supabase.storage.from("post-images").upload(fileName,compressed,{contentType:"image/jpeg"});
    const { data }=supabase.storage.from("post-images").getPublicUrl(fileName);
    urls.push(data.publicUrl);
  }
  return urls;
}

/* ================= AUTH ================= */

async function init(){
  const { data }=await supabase.auth.getUser();
  currentUser=data.user;
  loadPosts();
  subscribeRealtime();
}

async function login(){
  await supabase.auth.signInWithOAuth({provider:'google'});
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* ================= POSTS ================= */

async function createPost(){
  if(!currentUser) return alert("Login first");
  const content=document.getElementById("postInput").value;
  const files=document.getElementById("imageInput").files;
  let imageUrls=[];
  if(files.length>0){
    imageUrls=await uploadImages(files);
  }
  if(!content && imageUrls.length===0) return;
  await supabase.from("posts").insert([{
    content,
    images:imageUrls,
    user_id:currentUser.id,
    username:currentUser.email
  }]);
  document.getElementById("postInput").value="";
  document.getElementById("imageInput").value="";
}

async function toggleLike(postId){
  if(!currentUser) return alert("Login first");
  const { data }=await supabase.from("likes")
    .select("*")
    .eq("post_id",postId)
    .eq("user_id",currentUser.id)
    .maybeSingle();
  if(data){
    await supabase.from("likes").update({active:!data.active}).eq("id",data.id);
  }else{
    await supabase.from("likes").insert([{post_id:postId,user_id:currentUser.id,active:true}]);
  }
}

async function loadPosts(){
  const { data:posts }=await supabase.from("posts")
    .select("*")
    .order("created_at",{ascending:false});
  document.getElementById("posts").innerHTML="";
  posts.forEach(post=>renderPost(post));
}

async function renderPost(post){

  const { count }=await supabase.from("likes")
    .select("*",{count:"exact",head:true})
    .eq("post_id",post.id)
    .eq("active",true);

  let imagesHTML="";
  if(post.images){
    post.images.forEach(url=>{
      imagesHTML+=`<div class="image-preview"><img src="${url}"></div>`;
    });
  }

  const div=document.createElement("div");
  div.className="post";
  div.id="post-"+post.id;

  div.innerHTML=`
    <b>${post.username}</b>
    <div class="small">${timeAgo(post.created_at)}</div>
    <div>${post.content||""}</div>
    ${imagesHTML}
    ‚ù§Ô∏è <span id="like-count-${post.id}">${count||0}</span>
    <br>
    <button onclick="toggleLike('${post.id}')">Like</button>
    <div id="comments-${post.id}"></div>
    <textarea id="comment-input-${post.id}" class="comment-input" placeholder="Write comment..."></textarea>
    <button onclick="addComment('${post.id}')">Comment</button>
  `;

  document.getElementById("posts").appendChild(div);
  loadComments(post.id);
}

/* ================= COMMENTS ================= */

async function addComment(postId){
  if(!currentUser) return alert("Login first");
  const input=document.getElementById("comment-input-"+postId);
  const text=input.value;
  if(!text) return;
  await supabase.from("comments").insert([{
    post_id:postId,
    user_id:currentUser.id,
    username:currentUser.email,
    content:text
  }]);
  input.value="";
}

async function deleteComment(commentId){
  await supabase.from("comments").delete().eq("id",commentId);
}

async function loadComments(postId){
  const { data }=await supabase.from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});

  const container=document.getElementById("comments-"+postId);
  container.innerHTML="";
  data.forEach(c=>{
    const timeText=c.updated_at && c.updated_at!==c.created_at
      ? "Edited ‚Ä¢ "+timeAgo(c.updated_at)
      : timeAgo(c.created_at);

    container.innerHTML+=`
      <div class="comment-box">
        <b>${c.username}</b>
        <span class="small">${timeText}</span>
        <br>${c.content}
        ${
          currentUser && currentUser.id===c.user_id
          ? `<br><button onclick="deleteComment('${c.id}')">Delete</button>`
          : ""
        }
      </div>
    `;
  });
}

/* ================= REALTIME ================= */

function subscribeRealtime(){
  supabase.channel("all-channel")
    .on("postgres_changes",{event:"*",schema:"public",table:"posts"},()=>loadPosts())
    .on("postgres_changes",{event:"*",schema:"public",table:"likes"},()=>loadPosts())
    .on("postgres_changes",{event:"*",schema:"public",table:"comments"},()=>{
      document.querySelectorAll(".post").forEach(post=>{
        const postId=post.id.replace("post-","");
        loadComments(postId);
      });
    })
    .subscribe();
}

/* ================= DARK ================= */

function toggleDark(){
  document.body.classList.toggle("dark");
}

window.toggleLike=toggleLike;
window.addComment=addComment;
window.deleteComment=deleteComment;

document.getElementById("darkBtn").onclick=toggleDark;
document.getElementById("loginBtn").onclick=login;
document.getElementById("logoutBtn").onclick=logout;
document.getElementById("postBtn").onclick=createPost;

init();

});
</script>
</body>
</html>