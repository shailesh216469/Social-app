<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body { font-family: Arial; padding: 20px; }
button { margin: 5px; cursor:pointer; }
textarea { width: 100%; max-width: 400px; }
.post {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}
</style>
</head>

<body>

<h2>üî• Ultimate Social App</h2>

<div id="authSection">
  <button id="googleBtn">Login with Google</button>
  <button id="guestBtn">Guest Login</button>
</div>

<div id="appSection" style="display:none;">

  <p id="userInfo"></p>
  <button id="logoutBtn">Logout</button>

  <hr>

  <textarea id="postInput" placeholder="Write something..." rows="3"></textarea><br>
  <button id="postBtn">Post</button>

  <hr>

  <div id="posts"></div>

</div>


<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;

const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");
const userInfo = document.getElementById("userInfo");
const postInput = document.getElementById("postInput");
const postBtn = document.getElementById("postBtn");
const postsContainer = document.getElementById("posts");


// ================= SESSION =================

const { data: { session } } = await supabase.auth.getSession();

if (session) {
  currentUser = session.user;
  showApp();
}


// ================= AUTH =================

googleBtn.onclick = async () => {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.origin }
  });
};

guestBtn.onclick = async () => {
  const { data, error } = await supabase.auth.signInAnonymously();
  if (error) return alert(error.message);

  currentUser = data.user;
  showApp();
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

function showApp() {
  authSection.style.display = "none";
  appSection.style.display = "block";
  userInfo.innerText = "Logged in as: " + (currentUser.email || "Guest");
  loadPosts();
}


// ================= CREATE POST =================

postBtn.onclick = async () => {
  const content = postInput.value.trim();
  if (!content) return;

  const { error } = await supabase.from("posts").insert({
    content,
    user_id: currentUser.id
  });

  if (error) return alert(error.message);

  postInput.value = "";
};


// ================= LOAD POSTS =================

async function loadPosts() {
  const { data: posts, error } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) return console.error(error);

  renderPosts(posts);
}


// ================= RENDER POSTS =================

async function renderPosts(posts) {
  postsContainer.innerHTML = "";

  for (let post of posts) {
    const element = await buildPostElement(post);
    postsContainer.appendChild(element);
  }

  attachLikeEvents();
}


// ================= BUILD POST =================

async function buildPostElement(post) {

  const { data: likesData } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id", post.id);

  const likeCount = likesData ? likesData.length : 0;

  const alreadyLiked = likesData?.some(
    like => like.user_id === currentUser.id
  );

  const div = document.createElement("div");
  div.className = "post";
  div.setAttribute("data-post", post.id);

  div.innerHTML = `
    <p>${post.content}</p>
    <button class="likeBtn" data-id="${post.id}">
      ${alreadyLiked ? "‚ù§Ô∏è Liked" : "ü§ç Like"}
    </button>
    <span class="likeCount">${likeCount} likes</span>
  `;

  return div;
}


// ================= LIKE TOGGLE =================

function attachLikeEvents() {
  document.querySelectorAll(".likeBtn").forEach(button => {

    button.onclick = async () => {
      const postId = button.dataset.id;

      const { data: existing } = await supabase
        .from("likes")
        .select("id")
        .eq("post_id", postId)
        .eq("user_id", currentUser.id);

      if (existing && existing.length > 0) {
        // Unlike
        await supabase
          .from("likes")
          .delete()
          .eq("post_id", postId)
          .eq("user_id", currentUser.id);
      } else {
        // Like
        await supabase
          .from("likes")
          .insert({
            post_id: postId,
            user_id: currentUser.id
          });
      }
    };

  });
}


// ================= SMART REALTIME =================

const channel = supabase.channel("smart-realtime");

// üîπ New Post
channel.on(
  "postgres_changes",
  { event: "INSERT", schema: "public", table: "posts" },
  async (payload) => {
    const element = await buildPostElement(payload.new);
    postsContainer.prepend(element);
    attachLikeEvents();
  }
);

// üîπ Like / Unlike
channel.on(
  "postgres_changes",
  { event: "*", schema: "public", table: "likes" },
  async (payload) => {

    // Handle INSERT and DELETE correctly
    const postId =
      payload.eventType === "DELETE"
        ? payload.old.post_id
        : payload.new.post_id;

    const postElement = document.querySelector(
      `[data-post="${postId}"]`
    );

    if (!postElement) return;

    const { data: likesData } = await supabase
      .from("likes")
      .select("*")
      .eq("post_id", postId);

    const likeCount = likesData ? likesData.length : 0;

    const alreadyLiked = likesData?.some(
      like => like.user_id === currentUser.id
    );

    postElement.querySelector(".likeBtn").innerText =
      alreadyLiked ? "‚ù§Ô∏è Liked" : "ü§ç Like";

    postElement.querySelector(".likeCount").innerText =
      likeCount + " likes";
  }
);

channel.subscribe();

</script>

</body>
</html>