<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{font-family:system-ui;background:#f3f4f6;padding:20px;transition:.3s;}
.dark{background:#0f0f0f;color:white;}
.card{background:white;padding:16px;border-radius:12px;margin-top:15px;box-shadow:0 3px 10px rgba(0,0,0,0.05);}
.dark .card{background:#1c1c1c;}
button{padding:6px 12px;border:none;border-radius:8px;cursor:pointer;}
.primary{background:#4f46e5;color:white;}
.danger{background:#ef4444;color:white;}
.like-btn{background:#e5e7eb;}
.liked{background:#ef4444;color:white;}
textarea{width:100%;padding:8px;border-radius:8px;}
img{max-width:100%;border-radius:10px;margin-top:8px;}
.small{font-size:12px;opacity:.6;}
.comment-box{margin-top:10px;padding-left:10px;border-left:2px solid #ddd;}
</style>
</head>
<body>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div>
  <span id="userEmail"></span>
  <button id="googleBtn" class="primary">Google</button>
  <button id="guestBtn">Guest</button>
  <button id="logoutBtn">Logout</button>
  <button id="darkBtn">ðŸŒ™</button>
</div>

<div class="card">
  <textarea id="postInput" placeholder="Write something..."></textarea>
  <input type="file" id="imageInput" multiple accept="image/*">
  <button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const supabase = window.supabase.createClient(
"https://dgehzagvyrxbnnvgsiff.supabase.co",
"sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let user=null;

/* ===== TIME ===== */
function timeAgo(d){
 const s=Math.floor((Date.now()-new Date(d))/1000);
 if(s<60)return"Just now";
 if(s<3600)return Math.floor(s/60)+"m ago";
 if(s<86400)return Math.floor(s/3600)+"h ago";
 return Math.floor(s/86400)+"d ago";
}

/* ===== AUTH ===== */
async function init(){
 const {data}=await supabase.auth.getUser();
 user=data.user;
 updateUserUI();
 loadPosts();
 subscribeRealtime();
}

function updateUserUI(){
 document.getElementById("userEmail").innerText =
 user ? "Logged in: "+(user.email||"Guest") : "Not logged in";
}

document.getElementById("googleBtn").onclick=
()=>supabase.auth.signInWithOAuth({provider:"google"});

document.getElementById("guestBtn").onclick=
async()=>{
 const {data}=await supabase.auth.signInAnonymously();
 user=data.user;
 updateUserUI();
};

document.getElementById("logoutBtn").onclick=
async()=>{
 await supabase.auth.signOut();
 location.reload();
};

/* ===== CREATE POST ===== */
document.getElementById("postBtn").onclick=async()=>{
 if(!user)return alert("Login first");

 const content=document.getElementById("postInput").value;

 await supabase.from("posts").insert([{
  content,user_id:user.id,username:user.email
 }]);

 document.getElementById("postInput").value="";
};

/* ===== RENDER POST ===== */
async function renderPost(post){

 if(document.getElementById("post-"+post.id))return;

 const div=document.createElement("div");
 div.className="card";
 div.id="post-"+post.id;

 div.innerHTML=`
  <b>${post.username||"User"}</b>
  <div class="small">${timeAgo(post.created_at)}</div>
  <div id="post-content-${post.id}">${post.content||""}</div>

  ${
   user && user.id===post.user_id ?
   `<button onclick="editPost('${post.id}')">Edit</button>
    <button class="danger" onclick="deletePost('${post.id}')">Delete</button>`:""
  }

  <br><br>

  <button id="like-${post.id}" class="like-btn">Like</button>
  <span id="like-count-${post.id}">0</span>

  <div id="comments-${post.id}"></div>

  <textarea id="comment-input-${post.id}" placeholder="Comment..."></textarea>
  <button onclick="addComment('${post.id}')">Send</button>
 `;

 document.getElementById("feed").prepend(div);

 initLike(post.id);
 loadComments(post.id);
}

/* ===== POST DELETE ===== */
window.deletePost=async function(id){
 await supabase.from("posts").delete().eq("id",id);
};

/* ===== POST EDIT ===== */
window.editPost=function(id){
 const el=document.getElementById("post-content-"+id);
 const old=el.innerText;
 el.innerHTML=`
   <textarea id="edit-post-${id}">${old}</textarea>
   <button onclick="savePost('${id}')">Save</button>
 `;
};

window.savePost=async function(id){
 const val=document.getElementById("edit-post-"+id).value;
 await supabase.from("posts").update({content:val}).eq("id",id);
};

/* ===== LIKE ===== */
async function initLike(postId){

 const btn=document.getElementById("like-"+postId);

 const {count}=await supabase.from("likes")
  .select("*",{count:"exact",head:true})
  .eq("post_id",postId)
  .eq("active",true);

 document.getElementById("like-count-"+postId).innerText=count||0;

 btn.onclick=async()=>{
  if(!user)return alert("Login");

  const {data}=await supabase.from("likes")
   .select("*")
   .eq("post_id",postId)
   .eq("user_id",user.id)
   .maybeSingle();

  if(data){
   await supabase.from("likes")
    .update({active:!data.active})
    .eq("id",data.id);
  }else{
   await supabase.from("likes")
    .insert([{post_id:postId,user_id:user.id,active:true}]);
  }
 };
}

/* ===== COMMENTS ===== */
window.addComment=async function(postId){
 if(!user)return alert("Login");
 const input=document.getElementById("comment-input-"+postId);
 if(!input.value)return;
 await supabase.from("comments").insert([{
  post_id:postId,
  user_id:user.id,
  username:user.email,
  content:input.value
 }]);
 input.value="";
};

async function loadComments(postId){
 const {data}=await supabase.from("comments")
  .select("*")
  .eq("post_id",postId)
  .order("created_at",{ascending:true});

 const box=document.getElementById("comments-"+postId);
 box.innerHTML="";

 data.forEach(c=>{
  box.innerHTML+=`
   <div class="comment-box" id="comment-${c.id}">
    <b>${c.username}</b>
    <span class="small">${timeAgo(c.created_at)}</span>
    <div id="comment-content-${c.id}">${c.content}</div>

    ${
     user && user.id===c.user_id ?
     `<button onclick="editComment('${c.id}')">Edit</button>
      <button class="danger" onclick="deleteComment('${c.id}')">Delete</button>`:""
    }
   </div>
  `;
 });
}

/* ===== COMMENT DELETE ===== */
window.deleteComment=async function(id){
 await supabase.from("comments").delete().eq("id",id);
};

/* ===== COMMENT EDIT ===== */
window.editComment=function(id){
 const el=document.getElementById("comment-content-"+id);
 const old=el.innerText;
 el.innerHTML=`
  <textarea id="edit-comment-${id}">${old}</textarea>
  <button onclick="saveComment('${id}')">Save</button>
 `;
};

window.saveComment=async function(id){
 const val=document.getElementById("edit-comment-"+id).value;
 await supabase.from("comments").update({content:val}).eq("id",id);
};

/* ===== REALTIME ===== */
function subscribeRealtime(){

 supabase.channel("posts")
  .on("postgres_changes",
   {event:"INSERT",schema:"public",table:"posts"},
   p=>renderPost(p.new)
  )
  .on("postgres_changes",
   {event:"DELETE",schema:"public",table:"posts"},
   p=>document.getElementById("post-"+p.old.id)?.remove()
  )
  .on("postgres_changes",
   {event:"UPDATE",schema:"public",table:"posts"},
   p=>{
    const el=document.getElementById("post-content-"+p.new.id);
    if(el)el.innerText=p.new.content;
   }
  )
  .subscribe();

 supabase.channel("likes")
  .on("postgres_changes",
   {event:"*",schema:"public",table:"likes"},
   async p=>{
    const id=p.new?.post_id||p.old?.post_id;
    const {count}=await supabase.from("likes")
     .select("*",{count:"exact",head:true})
     .eq("post_id",id)
     .eq("active",true);
    const el=document.getElementById("like-count-"+id);
    if(el)el.innerText=count||0;
   }
  )
  .subscribe();

 supabase.channel("comments")
  .on("postgres_changes",
   {event:"*",schema:"public",table:"comments"},
   p=>{
    const id=p.new?.post_id||p.old?.post_id;
    if(id)loadComments(id);
   }
  )
  .subscribe();
}

/* ===== DARK ===== */
document.getElementById("darkBtn").onclick=
()=>document.body.classList.toggle("dark");

async function loadPosts(){
 const {data}=await supabase.from("posts")
  .select("*")
  .order("created_at",{ascending:false});
 data.forEach(renderPost);
}

init();

});
</script>
</body>
</html>