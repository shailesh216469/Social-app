<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üî• Ultimate Social App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .card { background:#f2f2f2; padding:15px; margin:15px 0; border-radius:10px; }
    button { padding:6px 10px; margin-top:5px; cursor:pointer; }
    input { padding:6px; }
  </style>
</head>
<body>

<h2>üî• Ultimate Social App</h2>

<div id="authSection">
  <button onclick="googleLogin()">Login with Google</button>
  <button onclick="guestLogin()">Guest Login</button>
</div>

<div id="appSection" style="display:none;">
  <p id="userInfo"></p>
  <button onclick="logout()">Logout</button>

  <br><br>

  <input id="postInput" placeholder="Write something..." />
  <button onclick="addPost()">Post</button>

  <div id="feed"></div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

checkUser();

async function checkUser() {
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    document.getElementById("authSection").style.display = "none";
    document.getElementById("appSection").style.display = "block";
    document.getElementById("userInfo").innerText =
      user.email ? user.email : "Guest";
    loadPosts();
    setupRealtime();
  }
}

async function googleLogin() {
  await supabase.auth.signInWithOAuth({
    provider: "google"
  });
}

async function guestLogin() {
  await supabase.auth.signInAnonymously();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

async function addPost() {
  const input = document.getElementById("postInput");
  const content = input.value.trim();
  if (!content) return;

  const { data: { user } } = await supabase.auth.getUser();

  await supabase.from("posts").insert({
    content: content,
    user_id: user.id,
    user_email: user.email || "Guest"
  });

  input.value = "";
}

async function loadPosts() {
  const { data } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  for (let post of data) {

    const { count } = await supabase
      .from("likes")
      .select("*", { count: "exact", head: true })
      .eq("post_id", post.id);

    const { data: comments } = await supabase
      .from("comments")
      .select("*")
      .eq("post_id", post.id);

    feed.innerHTML += `
      <div class="card">
        <b>${post.user_email}</b><br>
        ${post.content}<br><br>

        <button onclick="toggleLike(${post.id})">
          ‚ù§Ô∏è ${count || 0}
        </button>

        <div>
          <input id="comment-${post.id}" placeholder="Comment..." />
          <button onclick="addComment(${post.id})">Comment</button>
        </div>

        <div>
          ${comments.map(c => `<p><b>${c.user_email}</b>: ${c.content}</p>`).join("")}
        </div>
      </div>
    `;
  }
}

async function toggleLike(postId) {
  const { data: { user } } = await supabase.auth.getUser();

  const { data: existing } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id", postId)
    .eq("user_id", user.id)
    .maybeSingle();

  if (existing) {
    await supabase
      .from("likes")
      .delete()
      .eq("post_id", postId)
      .eq("user_id", user.id);
  } else {
    await supabase
      .from("likes")
      .insert({
        post_id: postId,
        user_id: user.id
      });
  }
}

async function addComment(postId) {
  const input = document.getElementById("comment-" + postId);
  const content = input.value.trim();
  if (!content) return;

  const { data: { user } } = await supabase.auth.getUser();

  await supabase.from("comments").insert({
    post_id: postId,
    content: content,
    user_id: user.id,
    user_email: user.email || "Guest"
  });

  input.value = "";
}

function setupRealtime() {
  supabase.channel("realtime")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "posts" },
      () => loadPosts()
    )
    .on("postgres_changes",
      { event: "*", schema: "public", table: "likes" },
      () => loadPosts()
    )
    .on("postgres_changes",
      { event: "*", schema: "public", table: "comments" },
      () => loadPosts()
    )
    .subscribe();
}
</script>

</body>
</html>