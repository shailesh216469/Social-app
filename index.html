<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{font-family:system-ui;background:#f3f4f6;padding:20px;transition:.3s;}
.dark{background:#0f0f0f;color:white;}
.card{background:white;padding:16px;border-radius:16px;margin-top:20px;box-shadow:0 4px 20px rgba(0,0,0,.06);}
.dark .card{background:#1c1c1c;}
button{padding:6px 12px;border:none;border-radius:10px;cursor:pointer;margin-right:5px;margin-top:5px;}
.primary{background:#4f46e5;color:white;}
.danger{background:#ef4444;color:white;}
.like-btn{background:#e5e7eb;}
.liked{background:#ef4444;color:white;}
textarea{width:100%;padding:10px;border-radius:12px;margin-top:5px;}
.small{font-size:12px;opacity:.6;}
.comment-box{margin-top:10px;padding-left:10px;border-left:2px solid #ddd;}

.image-grid{display:grid;gap:6px;margin-top:10px;}
.image-grid.single{grid-template-columns:1fr;}
.image-grid.two{grid-template-columns:1fr 1fr;}
.image-grid.multi{grid-template-columns:repeat(3,1fr);}
.image-grid img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;cursor:pointer;}
</style>
</head>
<body>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div>
<span id="userEmail"></span>
<button id="googleBtn" class="primary">Google</button>
<button id="guestBtn">Guest</button>
<button id="logoutBtn">Logout</button>
<button id="darkBtn">ðŸŒ™</button>
</div>

<div class="card">
<textarea id="postInput" placeholder="Write something..."></textarea>
<input type="file" id="imageInput" multiple accept="image/*">
<button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const supabase = window.supabase.createClient(
"https://dgehzagvyrxbnnvgsiff.supabase.co",
"sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let user=null;

/* ================= AUTH ================= */

async function init(){
 const {data}=await supabase.auth.getUser();
 user=data.user;
 updateUserUI();

 supabase.auth.onAuthStateChange((event, session)=>{
   user=session?.user||null;
   updateUserUI();
 });

 loadPosts();
 subscribeRealtime();
}

function updateUserUI(){
 document.getElementById("userEmail").innerText =
 user ? "Logged in: "+(user.email||"Guest") : "Not logged in";
}

googleBtn.onclick=()=>supabase.auth.signInWithOAuth({provider:"google"});

guestBtn.onclick=async()=>{
 const {data}=await supabase.auth.signInAnonymously();
 user=data.user;
 updateUserUI();
};

logoutBtn.onclick=async()=>{
 await supabase.auth.signOut();
 location.reload();
};

/* ================= IMAGE UPLOAD ================= */

async function compressImage(file){
 return new Promise(res=>{
  const r=new FileReader();
  r.readAsDataURL(file);
  r.onload=e=>{
   const img=new Image();
   img.src=e.target.result;
   img.onload=()=>{
    const canvas=document.createElement("canvas");
    const MAX=1080;
    let w=img.width,h=img.height;
    if(w>MAX){h=h*(MAX/w);w=MAX;}
    canvas.width=w;canvas.height=h;
    canvas.getContext("2d").drawImage(img,0,0,w,h);
    canvas.toBlob(b=>res(b),"image/jpeg",0.7);
   }
  }
 })
}

/* ================= CREATE POST ================= */

postBtn.onclick=async()=>{
 if(!user)return alert("Login first");

 const content=postInput.value;
 const files=imageInput.files;
 let urls=[];

 for(const f of files){
  const blob=await compressImage(f);
  const name=Date.now()+"-"+Math.random()+".jpg";
  await supabase.storage.from("post-images").upload(name,blob);
  const {data}=supabase.storage.from("post-images").getPublicUrl(name);
  urls.push(data.publicUrl);
 }

 const {data}=await supabase.from("posts").insert([{
  content,images:urls,user_id:user.id,username:user.email
 }]).select().single();

 renderPost(data);

 postInput.value="";
 imageInput.value="";
};

/* ================= RENDER POST ================= */

function renderPost(post){

 if(document.getElementById("post-"+post.id)) return;

 const div=document.createElement("div");
 div.className="card";
 div.id="post-"+post.id;

 div.innerHTML=createPostHTML(post);

 feed.prepend(div);

 initLike(post.id);
 loadComments(post.id);
}

function createPostHTML(post){

 let grid="";
 if(post.images && post.images.length){
  let type="single";
  if(post.images.length===2) type="two";
  if(post.images.length>=3) type="multi";
  grid=`<div class="image-grid ${type}">`;
  post.images.forEach(u=>grid+=`<img src="${u}">`);
  grid+=`</div>`;
 }

 return `
  <b>${post.username}</b>
  <div id="post-text-${post.id}">${post.content||""}</div>

  ${
   user && user.id===post.user_id
   ? `<button onclick="editPost('${post.id}')">Edit</button>
      <button class="danger" onclick="deletePost('${post.id}')">Delete</button>`
   : ""
  }

  ${grid}

  <br>
  <button id="like-${post.id}" class="like-btn">Like</button>
  <span id="like-count-${post.id}">0</span>

  <div id="comments-${post.id}"></div>
  <textarea id="comment-input-${post.id}"></textarea>
  <button onclick="addComment('${post.id}')">Send</button>
 `;
}

/* ================= EDIT POST (TEXT + IMAGE) ================= */

window.editPost=function(id){
 const post=document.getElementById("post-"+id);
 const text=document.getElementById("post-text-"+id).innerText;

 post.innerHTML=`
   <textarea id="edit-text-${id}">${text}</textarea>
   <input type="file" id="edit-img-${id}" multiple accept="image/*">
   <button onclick="savePost('${id}')">Save</button>
 `;
}

window.savePost=async function(id){
 const text=document.getElementById("edit-text-"+id).value;
 await supabase.from("posts").update({content:text}).eq("id",id);
};

/* ================= DELETE POST ================= */

window.deletePost=async function(id){
 await supabase.from("posts").delete().eq("id",id);
 document.getElementById("post-"+id)?.remove();
};

/* ================= LIKE ================= */

async function initLike(postId){
 const btn=document.getElementById("like-"+postId);

 const {count}=await supabase.from("likes")
  .select("*",{count:"exact",head:true})
  .eq("post_id",postId)
  .eq("active",true);

 document.getElementById("like-count-"+postId).innerText=count||0;

 btn.onclick=async()=>{
  const {data}=await supabase.from("likes")
   .select("*")
   .eq("post_id",postId)
   .eq("user_id",user.id)
   .maybeSingle();

  if(data){
   await supabase.from("likes")
    .update({active:!data.active})
    .eq("id",data.id);
  }else{
   await supabase.from("likes")
    .insert([{post_id:postId,user_id:user.id,active:true}]);
  }

  const {count:newCount}=await supabase.from("likes")
   .select("*",{count:"exact",head:true})
   .eq("post_id",postId)
   .eq("active",true);

  document.getElementById("like-count-"+postId).innerText=newCount||0;
 };
}

/* ================= COMMENTS ================= */

window.addComment=async function(postId){
 const input=document.getElementById("comment-input-"+postId);
 if(!input.value)return;

 const {data}=await supabase.from("comments")
  .insert([{
   post_id:postId,
   user_id:user.id,
   username:user.email,
   content:input.value
  }]).select().single();

 appendComment(data);
 input.value="";
}

function appendComment(c){
 const box=document.getElementById("comments-"+c.post_id);
 box.innerHTML+=`
  <div id="comment-${c.id}" class="comment-box">
   <b>${c.username}</b>
   <div>${c.content}</div>
   <button onclick="deleteComment('${c.id}')">Delete</button>
  </div>
 `;
}

window.deleteComment=async function(id){
 await supabase.from("comments").delete().eq("id",id);
 document.getElementById("comment-"+id)?.remove();
};

/* ================= LOAD ================= */

async function loadPosts(){
 const {data}=await supabase.from("posts")
  .select("*")
  .order("created_at",{ascending:false});
 data.forEach(renderPost);
}

async function loadComments(postId){
 const {data}=await supabase.from("comments")
  .select("*")
  .eq("post_id",postId)
  .order("created_at",{ascending:true});
 data.forEach(appendComment);
}

/* ================= REALTIME ================= */

function subscribeRealtime(){

 supabase.channel("posts")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},
   p=>renderPost(p.new))
  .on("postgres_changes",{event:"DELETE",schema:"public",table:"posts"},
   p=>document.getElementById("post-"+p.old.id)?.remove())
  .subscribe();

 supabase.channel("comments")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"comments"},
   p=>appendComment(p.new))
  .on("postgres_changes",{event:"DELETE",schema:"public",table:"comments"},
   p=>document.getElementById("comment-"+p.old.id)?.remove())
  .subscribe();
}

darkBtn.onclick=()=>document.body.classList.toggle("dark");

init();
});
</script>
</body>
</html>