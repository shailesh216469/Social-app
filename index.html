<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stable Social App</title>
<style>
body { font-family: Arial; padding: 20px; }
.post { border:1px solid #ccc; padding:10px; margin-top:10px; border-radius:6px; }
.likeBtn { padding:4px 8px; }
</style>
</head>
<body>

<h2>üî• Stable Social App</h2>

<div id="auth">
  <button id="google">Login Google</button>
  <button id="guest">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout">Logout</button>
  <hr>
  <textarea id="text" rows="3"></textarea><br>
  <button id="post">Post</button>
  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;
const authDiv = document.getElementById("auth");
const appDiv = document.getElementById("app");
const userText = document.getElementById("user");
const feed = document.getElementById("feed");


// ================= AUTH =================

const { data:{ session } } = await supabase.auth.getSession();
if (session) {
  currentUser = session.user;
  showApp();
}

google.onclick = async () => {
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{ redirectTo: window.location.origin }
  });
};

guest.onclick = async () => {
  const { data } = await supabase.auth.signInAnonymously();
  currentUser = data.user;
  showApp();
};

logout.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  authDiv.style.display="none";
  appDiv.style.display="block";
  userText.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}


// ================= CREATE POST =================

post.onclick = async ()=>{
  const value = text.value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  text.value="";
};


// ================= LOAD POSTS =================

async function loadPosts(){
  const { data } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  feed.innerHTML="";
  for(const post of data){
    await renderPost(post);
  }
}


// ================= RENDER POST =================

async function renderPost(post){

  const { data:likes } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id",post.id)
    .eq("active",true);

  const likeCount = likes.length;

  const { data:myLike } = await supabase
    .from("likes")
    .select("active")
    .eq("post_id",post.id)
    .eq("user_id",currentUser.id)
    .maybeSingle();

  const isLiked = myLike?.active === true;

  const div = document.createElement("div");
  div.className="post";
  div.setAttribute("data-id",post.id);

  div.innerHTML = `
    <p>${post.content}</p>
    <button class="likeBtn">${isLiked?"‚ù§Ô∏è Liked":"ü§ç Like"}</button>
    <span class="likeCount">${likeCount} likes</span>
  `;

  feed.appendChild(div);

  div.querySelector(".likeBtn").onclick = async ()=>{
    await toggleLike(post.id);
  };
}


// ================= TOGGLE LIKE (ACTIVE SYSTEM) =================

async function toggleLike(postId){

  const { data:existing } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id",postId)
    .eq("user_id",currentUser.id)
    .maybeSingle();

  if(existing){
    // Just toggle active state
    await supabase
      .from("likes")
      .update({ active: !existing.active })
      .eq("id",existing.id);
  }else{
    await supabase.from("likes").insert({
      post_id:postId,
      user_id:currentUser.id,
      active:true
    });
  }
}


// ================= REALTIME =================

supabase.channel("realtime")
  .on("postgres_changes",
      {event:"*",schema:"public",table:"posts"},
      ()=>loadPosts()
  )
  .on("postgres_changes",
      {event:"*",schema:"public",table:"likes"},
      async (payload)=>{

        const postId = payload.new?.post_id || payload.old?.post_id;
        if(!postId) return;

        // Remove only that post
        const oldDiv = document.querySelector(`[data-id="${postId}"]`);
        if(oldDiv) oldDiv.remove();

        // Re-render fresh from DB
        const { data:post } = await supabase
          .from("posts")
          .select("*")
          .eq("id",postId)
          .single();

        if(post) await renderPost(post);
      }
  )
  .subscribe();

</script>
</body>
</html>