<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{
  font-family: Arial;
  padding:20px;
  background:#f4f4f4;
  transition:0.3s;
}
.dark{
  background:#111;
  color:white;
}
.post{
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:8px;
}
.dark .post{
  background:#1e1e1e;
}
button{
  margin-right:5px;
}
</style>
</head>
<body>

<button id="darkBtn">üåô Dark Mode</button>

<h2>üî• Ultimate Social App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn">Logout</button>

<hr>

<textarea id="postInput" placeholder="Write something..."></textarea>
<br><br>
<button id="postBtn">Post</button>

<div id="posts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>

document.addEventListener("DOMContentLoaded", function(){

  const supabase = window.supabase.createClient(
    "https://dgehzagvyrxbnnvgsiff.supabase.co",
    "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
  );

  let currentUser = null;

  async function init(){
    const { data } = await supabase.auth.getUser();
    currentUser = data.user;
    loadPosts();
    subscribeRealtime();
  }

  function toggleDark(){
    document.body.classList.toggle("dark");
  }

  async function login(){
    await supabase.auth.signInWithOAuth({ provider: 'google' });
  }

  async function logout(){
    await supabase.auth.signOut();
    location.reload();
  }

  async function createPost(){
    if(!currentUser){
      alert("Login first");
      return;
    }

    const content = document.getElementById("postInput").value;
    if(!content) return;

    await supabase.from("posts").insert([{
      content: content,
      user_id: currentUser.id,
      username: currentUser.email
    }]);

    document.getElementById("postInput").value="";
  }

  async function deletePost(id){
    await supabase.from("posts").delete().eq("id", id);
  }

  async function likePost(id){
    if(!currentUser){
      alert("Login first");
      return;
    }

    await supabase.from("likes").insert([{
      post_id:id,
      user_id:currentUser.id
    }]);
  }

  async function loadPosts(){
    const { data:posts } = await supabase
      .from("posts")
      .select("*")
      .order("created_at",{ascending:false});

    const container = document.getElementById("posts");
    container.innerHTML="";

    if(!posts) return;

    for(const post of posts){
      renderPost(post);
    }
  }

  async function renderPost(post){

    const { count } = await supabase
      .from("likes")
      .select("*",{count:"exact",head:true})
      .eq("post_id",post.id);

    const container = document.getElementById("posts");

    // prevent duplicate rendering
    if(document.getElementById("post-"+post.id)) return;

    const div = document.createElement("div");
    div.className="post";
    div.id="post-"+post.id;

    div.innerHTML=`
      <b>${post.username || "User"}</b><br>
      ${post.content}
      <br><br>
      ‚ù§Ô∏è ${count || 0}
      <br><br>
      <button onclick="likePost('${post.id}')">Like</button>
      ${
        currentUser && currentUser.id===post.user_id
        ? `<button onclick="deletePost('${post.id}')">Delete</button>`
        : ""
      }
    `;

    container.prepend(div);
  }

  function removePost(id){
    const el = document.getElementById("post-"+id);
    if(el) el.remove();
  }

  function subscribeRealtime(){

    supabase
      .channel("posts-realtime")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "posts" },
        payload => {

          if(payload.eventType === "INSERT"){
            renderPost(payload.new);
          }

          if(payload.eventType === "DELETE"){
            removePost(payload.old.id);
          }

        }
      )
      .subscribe();
  }

  document.getElementById("darkBtn").onclick = toggleDark;
  document.getElementById("loginBtn").onclick = login;
  document.getElementById("logoutBtn").onclick = logout;
  document.getElementById("postBtn").onclick = createPost;

  window.likePost = likePost;
  window.deletePost = deletePost;

  init();

});

</script>

</body>
</html>