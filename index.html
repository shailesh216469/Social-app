<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stable Social App</title>
<style>
body { font-family: Arial; padding: 20px; }
.post { border:1px solid #ccc; padding:10px; margin-top:10px; border-radius:6px; }
</style>
</head>
<body>

<h2>üî• Stable Social App</h2>

<div id="auth">
  <button id="google">Login Google</button>
  <button id="guest">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout">Logout</button>
  <hr>
  <textarea id="text" rows="3"></textarea><br>
  <button id="post">Post</button>
  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;

const authDiv = document.getElementById("auth");
const appDiv = document.getElementById("app");
const userText = document.getElementById("user");
const feed = document.getElementById("feed");


// ================= AUTH =================

const { data:{ session } } = await supabase.auth.getSession();
if (session) {
  currentUser = session.user;
  showApp();
}

document.getElementById("google").onclick = async () => {
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{ redirectTo: window.location.origin }
  });
};

document.getElementById("guest").onclick = async () => {
  const { data } = await supabase.auth.signInAnonymously();
  currentUser = data.user;
  showApp();
};

document.getElementById("logout").onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  authDiv.style.display="none";
  appDiv.style.display="block";
  userText.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}


// ================= CREATE POST =================

document.getElementById("post").onclick = async ()=>{
  const value = document.getElementById("text").value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  document.getElementById("text").value="";
};


// ================= LOAD POSTS =================

async function loadPosts(){
  const { data } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  feed.innerHTML="";
  for(const post of data){
    await renderPost(post);
  }
}


// ================= RENDER ONE POST =================

async function renderPost(post){

  const { count } = await supabase
    .from("likes")
    .select("*",{count:"exact",head:true})
    .eq("post_id",post.id);

  const { data:liked } = await supabase
    .from("likes")
    .select("id")
    .eq("post_id",post.id)
    .eq("user_id",currentUser.id);

  const div = document.createElement("div");
  div.className="post";
  div.setAttribute("data-id",post.id);

  div.innerHTML = `
    <p>${post.content}</p>
    <button>${liked.length>0?"‚ù§Ô∏è Liked":"ü§ç Like"}</button>
    <span>${count||0} likes</span>
  `;

  feed.appendChild(div);

  div.querySelector("button").onclick = async ()=>{
    await toggleLike(post.id);
  };
}


// ================= TOGGLE LIKE =================

async function toggleLike(postId){

  const { data:existing } = await supabase
    .from("likes")
    .select("id")
    .eq("post_id",postId)
    .eq("user_id",currentUser.id);

  if(existing.length>0){
    await supabase
      .from("likes")
      .delete()
      .eq("post_id",postId)
      .eq("user_id",currentUser.id);
  }else{
    await supabase.from("likes").insert({
      post_id:postId,
      user_id:currentUser.id
    });
  }
}


// ================= REALTIME =================

supabase.channel("realtime")
  .on("postgres_changes",
      {event:"*",schema:"public",table:"posts"},
      ()=>loadPosts()
  )
  .on("postgres_changes",
      {event:"*",schema:"public",table:"likes"},
      async (payload)=>{

        const postId =
          payload.new?.post_id || payload.old?.post_id;

        if(!postId) return;

        // Remove only that post from UI
        const oldDiv = document.querySelector(`[data-id="${postId}"]`);
        if(oldDiv) oldDiv.remove();

        // Fetch fresh post
        const { data:post } = await supabase
          .from("posts")
          .select("*")
          .eq("id",postId)
          .single();

        if(post) await renderPost(post);
      }
  )
  .subscribe();

</script>
</body>
</html>