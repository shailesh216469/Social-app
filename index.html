<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî• Ultimate Social App</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
.card { background:#f2f2f2; padding:15px; margin:15px 0; border-radius:10px; }
button { padding:6px 10px; margin-top:5px; cursor:pointer; }
input { padding:6px; }
</style>
</head>

<body>

<h2>üî• Ultimate Social App</h2>

<div id="authSection">
  <button id="googleBtn">Login with Google</button>
  <button id="guestBtn">Guest Login</button>
</div>

<div id="appSection" style="display:none;">
  <p id="userInfo"></p>
  <button id="logoutBtn">Logout</button>

  <br><br>

  <input id="postInput" placeholder="Write something..." />
  <button id="postBtn">Post</button>

  <div id="feed"></div>
</div>

<script>

const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

// ---------------- AUTH ----------------

document.getElementById("googleBtn").addEventListener("click", async () => {
  await supabase.auth.signInWithOAuth({ provider: "google" });
});

document.getElementById("guestBtn").addEventListener("click", async () => {
  await supabase.auth.signInAnonymously();
});

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  location.reload();
});

// ---------------- CHECK USER ----------------

async function checkUser() {
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    document.getElementById("authSection").style.display = "none";
    document.getElementById("appSection").style.display = "block";
    document.getElementById("userInfo").innerText =
      user.email ? user.email : "Guest";
    loadPosts();
    setupRealtime();
  }
}

checkUser();

// ---------------- POST ----------------

document.getElementById("postBtn").addEventListener("click", async () => {
  const input = document.getElementById("postInput");
  const content = input.value.trim();
  if (!content) return;

  const { data: { user } } = await supabase.auth.getUser();

  await supabase.from("posts").insert({
    content,
    user_id: user.id,
    user_email: user.email || "Guest"
  });

  input.value = "";
});

// ---------------- LOAD POSTS ----------------

async function loadPosts() {
  const { data } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  for (let post of data) {

    const { count } = await supabase
      .from("likes")
      .select("*", { count: "exact", head: true })
      .eq("post_id", post.id);

    const { data: comments } = await supabase
      .from("comments")
      .select("*")
      .eq("post_id", post.id);

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <b>${post.user_email}</b><br>
      ${post.content}<br><br>
      <button data-id="${post.id}" class="likeBtn">
        ‚ù§Ô∏è ${count || 0}
      </button>
      <div>
        <input id="comment-${post.id}" placeholder="Comment..." />
        <button data-id="${post.id}" class="commentBtn">Comment</button>
      </div>
      <div>
        ${comments.map(c => `<p><b>${c.user_email}</b>: ${c.content}</p>`).join("")}
      </div>
    `;

    feed.appendChild(card);
  }

  attachLikeHandlers();
  attachCommentHandlers();
}

// ---------------- LIKE ----------------

function attachLikeHandlers() {
  document.querySelectorAll(".likeBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const postId = btn.dataset.id;
      const { data: { user } } = await supabase.auth.getUser();

      const { data: existing } = await supabase
        .from("likes")
        .select("*")
        .eq("post_id", postId)
        .eq("user_id", user.id)
        .maybeSingle();

      if (existing) {
        await supabase.from("likes")
          .delete()
          .eq("post_id", postId)
          .eq("user_id", user.id);
      } else {
        await supabase.from("likes")
          .insert({ post_id: postId, user_id: user.id });
      }
    });
  });
}

// ---------------- COMMENT ----------------

function attachCommentHandlers() {
  document.querySelectorAll(".commentBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const postId = btn.dataset.id;
      const input = document.getElementById("comment-" + postId);
      const content = input.value.trim();
      if (!content) return;

      const { data: { user } } = await supabase.auth.getUser();

      await supabase.from("comments").insert({
        post_id: postId,
        content,
        user_id: user.id,
        user_email: user.email || "Guest"
      });

      input.value = "";
    });
  });
}

// ---------------- REALTIME ----------------

function setupRealtime() {
  supabase.channel("realtime")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "posts" },
      loadPosts
    )
    .on("postgres_changes",
      { event: "*", schema: "public", table: "likes" },
      loadPosts
    )
    .on("postgres_changes",
      { event: "*", schema: "public", table: "comments" },
      loadPosts
    )
    .subscribe();
}

</script>

</body>
</html>