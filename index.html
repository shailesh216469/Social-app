<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Ultimate Social App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    button {
      padding: 8px 14px;
      margin: 5px;
      cursor: pointer;
    }
    .card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }
    #appSection {
      display: none;
    }
  </style>
</head>
<body>

<h1>üî• Ultimate Social App</h1>

<!-- AUTH SECTION -->
<div id="authSection">
  <button id="googleBtn">Login with Google</button>
  <button id="guestBtn">Guest Login</button>
</div>

<!-- APP SECTION -->
<div id="appSection">
  <p>Logged in as: <b id="userInfo"></b></p>
  <button id="logoutBtn">Logout</button>

  <hr>

  <h3>Create Post</h3>
  <textarea id="postInput" rows="3" style="width:100%"></textarea><br>
  <button id="postBtn">Post</button>

  <hr>

  <h3>Posts</h3>
  <div id="postsContainer"></div>
</div>

<script>
/* =========================
   SUPABASE CONFIG
========================= */

const SUPABASE_URL = "https://dgehzagvyrxbnnvgsiff.supabase.co";
const SUPABASE_KEY = "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   ELEMENTS
========================= */

const googleBtn = document.getElementById("googleBtn");
const guestBtn = document.getElementById("guestBtn");
const logoutBtn = document.getElementById("logoutBtn");
const postBtn = document.getElementById("postBtn");

const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");
const userInfo = document.getElementById("userInfo");
const postsContainer = document.getElementById("postsContainer");

/* =========================
   AUTH SYSTEM
========================= */

googleBtn.addEventListener("click", async () => {
  console.log("Google Clicked");

  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: window.location.origin
    }
  });
});

guestBtn.addEventListener("click", async () => {
  console.log("Guest Clicked");

  const { error } = await supabase.auth.signInAnonymously();

  if (error) {
    console.error(error);
  }
});

logoutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
  location.reload();
});

/* =========================
   AUTO UI UPDATE
========================= */

supabase.auth.onAuthStateChange((event, session) => {
  if (session?.user) {
    authSection.style.display = "none";
    appSection.style.display = "block";
    userInfo.innerText = session.user.email || "Guest";
    loadPosts();
  } else {
    authSection.style.display = "block";
    appSection.style.display = "none";
  }
});

/* =========================
   CREATE POST
========================= */

postBtn.addEventListener("click", async () => {
  const content = document.getElementById("postInput").value.trim();
  if (!content) return;

  const { data: { user } } = await supabase.auth.getUser();

  const { error } = await supabase
    .from("posts")
    .insert([{ content: content, user_id: user.id }]);

  if (!error) {
    document.getElementById("postInput").value = "";
  } else {
    console.error(error);
  }
});

/* =========================
   LOAD POSTS
========================= */

async function loadPosts() {
  postsContainer.innerHTML = "";

  const { data: posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  posts.forEach(post => renderPost(post));
}

/* =========================
   RENDER POST
========================= */

async function renderPost(post) {

  const { data: likes } = await supabase
    .from("likes")
    .select("*", { count: "exact" })
    .eq("post_id", post.id);

  const likeCount = likes.length;

  const card = document.createElement("div");
  card.className = "card";

  card.innerHTML = `
    <p>${post.content}</p>
    <button onclick="likePost('${post.id}')">‚ù§Ô∏è Like (${likeCount})</button>
  `;

  postsContainer.appendChild(card);
}

/* =========================
   LIKE SYSTEM (ONLY ONCE)
========================= */

async function likePost(postId) {

  const { data: { user } } = await supabase.auth.getUser();

  const { error } = await supabase
    .from("likes")
    .insert([{ post_id: postId, user_id: user.id }]);

  if (error) {
    console.log("Already liked");
  }

  loadPosts();
}

/* =========================
   REALTIME POSTS
========================= */

supabase
  .channel("posts-channel")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "posts" },
    () => {
      loadPosts();
    }
  )
  .subscribe();

</script>

</body>
</html>