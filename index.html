<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Website</title>

<style>
body{
  font-family: Arial;
  padding:20px;
  background:#f2f2f2;
}

.post{
  background:white;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.username{
  font-weight:bold;
  margin-bottom:5px;
}

.time{
  font-size:12px;
  color:gray;
  margin-top:5px;
}

button{
  margin:5px 0;
  padding:6px 10px;
  cursor:pointer;
}
</style>
</head>

<body>

<h2>üåç Social Website</h2>

<div id="authSection">
  <button id="googleBtn">Login with Google</button>
  <button id="guestBtn">Continue as Guest</button>
</div>

<div id="appSection" style="display:none;">
  <p>Logged in as: <span id="userEmail"></span></p>
  <button id="logoutBtn">Logout</button>

  <br><br>

  <input id="postInput" placeholder="Write something...">
  <button id="postBtn">Post</button>

  <div id="feed"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

document.addEventListener("DOMContentLoaded", function(){

  const supabase = window.supabase.createClient(
    "https://dgehzagvyrxbnnvgsiff.supabase.co",
    "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
  );

  const authSection = document.getElementById("authSection");
  const appSection = document.getElementById("appSection");
  const userEmailSpan = document.getElementById("userEmail");

  let currentUser = null;

  // Listen for login state
  supabase.auth.onAuthStateChange((event, session) => {
    if(session){
      currentUser = session.user;
      authSection.style.display="none";
      appSection.style.display="block";
      userEmailSpan.innerText = currentUser.email || "Guest";
      loadPosts();
    } else {
      currentUser = null;
      authSection.style.display="block";
      appSection.style.display="none";
    }
  });

  // Google Login
  document.getElementById("googleBtn").addEventListener("click", async ()=>{
    await supabase.auth.signInWithOAuth({
      provider:"google"
    });
  });

  // Guest Login
  document.getElementById("guestBtn").addEventListener("click", async ()=>{
    await supabase.auth.signInAnonymously();
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await supabase.auth.signOut();
  });

  // Post
  document.getElementById("postBtn").addEventListener("click", async ()=>{
    const text=document.getElementById("postInput").value;

    if(text.trim()==="") return;

    const { error } = await supabase
      .from("posts")
      .insert([{
        content:text,
        user_email: currentUser.email || "Guest"
      }]);

    if(!error){
      document.getElementById("postInput").value="";
      loadPosts();
    }
  });

  async function loadPosts(){
    const { data } = await supabase
      .from("posts")
      .select("*")
      .order("id",{ascending:false});

    const feed=document.getElementById("feed");
    feed.innerHTML="";

    data.forEach(p=>{

      const div=document.createElement("div");
      div.className="post";

      const username=document.createElement("div");
      username.className="username";
      username.innerText = p.user_email;

      const content=document.createElement("div");
      content.innerText = p.content;

      const time=document.createElement("div");
      time.className="time";
      time.innerText = timeAgo(p.created_at);

      div.appendChild(username);
      div.appendChild(content);
      div.appendChild(time);

      feed.appendChild(div);
    });
  }

  function timeAgo(dateString){

    const now = new Date();
    const past = new Date(dateString);
    const seconds = Math.floor((now - past) / 1000);

    const intervals = {
      year: 31536000,
      month: 2592000,
      day: 86400,
      hour: 3600,
      minute: 60
    };

    for (let key in intervals) {
      const value = Math.floor(seconds / intervals[key]);
      if (value >= 1) {
        return value + " " + key + (value > 1 ? "s ago" : " ago");
      }
    }

    return "Just now";
  }

});

</script>

</body>
</html>