<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family: Arial;
  margin:0;
  padding:20px;
  transition:0.3s;
  background:#f4f4f4;
  color:#111;
}
.dark{
  background:#111;
  color:#eee;
}
.container{
  max-width:600px;
  margin:auto;
}
.post{
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  background:#fff;
}
.dark .post{
  background:#1e1e1e;
}
button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-right:5px;
}
.like{
  background:#ff4d6d;
  color:white;
}
.delete{
  background:#e74c3c;
  color:white;
}
textarea{
  width:100%;
  padding:8px;
  border-radius:6px;
}
</style>
</head>
<body>

<div class="container">

<button onclick="toggleDark()">üåô Dark Mode</button>

<h2>üî• Ultimate Social App</h2>

<div id="authSection">
<button onclick="login()">Login with Google</button>
<button onclick="logout()">Logout</button>
<p id="userInfo"></p>
</div>

<hr>

<textarea id="postInput" placeholder="Write something..."></textarea>
<br><br>
<button onclick="createPost()">Post</button>

<div id="posts"></div>

</div>

<script>

const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;

async function checkUser(){
  const { data } = await supabase.auth.getUser();
  currentUser = data.user;

  if(currentUser){
    document.getElementById("userInfo").innerText =
      "Logged in as: " + currentUser.email;
  }
}
checkUser();

function toggleDark(){
  document.body.classList.toggle("dark");
}

async function login(){
  await supabase.auth.signInWithOAuth({
    provider: 'google'
  });
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function createPost(){
  if(!currentUser){
    alert("Login first");
    return;
  }

  const content = document.getElementById("postInput").value;
  if(!content) return;

  await supabase.from("posts").insert([{
    content: content,
    user_id: currentUser.id,
    username: currentUser.email
  }]);

  document.getElementById("postInput").value="";
  loadPosts();
}

async function deletePost(id){
  await supabase.from("posts").delete().eq("id", id);
  loadPosts();
}

async function likePost(id){
  if(!currentUser){
    alert("Login first");
    return;
  }

  await supabase.from("likes").insert([{
    post_id:id,
    user_id:currentUser.id
  }]);

  loadPosts();
}

async function loadPosts(){

  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  const container = document.getElementById("posts");
  container.innerHTML="";

  if(!posts) return;

  for(const post of posts){

    const { count } = await supabase
      .from("likes")
      .select("*",{count:"exact",head:true})
      .eq("post_id",post.id);

    const div = document.createElement("div");
    div.className="post";
    div.innerHTML=`
      <b>${post.username || "User"}</b><br>
      ${post.content}
      <br><br>
      ‚ù§Ô∏è ${count || 0}
      <br><br>
      <button class="like" onclick="likePost('${post.id}')">Like</button>
      ${
        currentUser && currentUser.id===post.user_id
        ? `<button class="delete" onclick="deletePost('${post.id}')">Delete</button>`
        : ""
      }
    `;
    container.appendChild(div);
  }
}

loadPosts();

</script>

</body>
</html>