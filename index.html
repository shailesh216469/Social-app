<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Ultimate Social App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; max-width: 600px; margin: auto; padding: 20px; }
    button { padding: 8px 12px; margin: 5px 0; cursor: pointer; }
    textarea { width: 100%; padding: 8px; }
    .post { border: 1px solid #ccc; padding: 10px; margin-top: 10px; border-radius: 6px; }
    .like-btn { background: #f0f0f0; border: none; padding: 5px 10px; }
  </style>
</head>
<body>

<h2>üî• Ultimate Social App</h2>

<div id="auth">
  <button id="googleBtn">Login with Google</button>
  <button id="guestBtn">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p>Welcome üëã <span id="userEmail"></span></p>
  <button onclick="logout()">Logout</button>

  <h3>Create Post</h3>
  <textarea id="postInput" placeholder="Write something..."></textarea><br>
  <button onclick="createPost()">Post</button>

  <h3>Posts</h3>
  <div id="posts"></div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;

document.getElementById("googleBtn").addEventListener("click", async () => {
  await supabase.auth.signInWithOAuth({
    provider: "google",
  });
});

document.getElementById("guestBtn").addEventListener("click", async () => {
  await supabase.auth.signInAnonymously();
});

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

supabase.auth.getSession().then(({ data }) => {
  if (data.session) {
    currentUser = data.session.user;
    startApp();
  }
});

supabase.auth.onAuthStateChange((event, session) => {
  if (session) {
    currentUser = session.user;
    startApp();
  }
});

function startApp() {
  document.getElementById("auth").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("userEmail").innerText =
    currentUser.email || "Guest User";

  loadPosts();
}

async function createPost() {
  const content = document.getElementById("postInput").value.trim();
  if (!content) return;

  await supabase.from("posts").insert({
    content: content,
    user_id: currentUser.id
  });

  document.getElementById("postInput").value = "";
  loadPosts();
}

async function loadPosts() {
  const { data: posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  const container = document.getElementById("posts");
  container.innerHTML = "";

  for (let post of posts) {
    const { count } = await supabase
      .from("likes")
      .select("*", { count: "exact", head: true })
      .eq("post_id", post.id);

    const { data: userLike } = await supabase
      .from("likes")
      .select("*")
      .eq("post_id", post.id)
      .eq("user_id", currentUser.id);

    const liked = userLike.length > 0;

    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <p>${post.content}</p>
      <button class="like-btn" onclick="toggleLike('${post.id}')">
        ${liked ? "‚ù§Ô∏è Unlike" : "ü§ç Like"} (${count})
      </button>
    `;
    container.appendChild(div);
  }
}

async function toggleLike(postId) {
  const { data: existing } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id", postId)
    .eq("user_id", currentUser.id);

  if (existing.length > 0) {
    await supabase
      .from("likes")
      .delete()
      .eq("post_id", postId)
      .eq("user_id", currentUser.id);
  } else {
    await supabase
      .from("likes")
      .insert({
        post_id: postId,
        user_id: currentUser.id
      });
  }

  loadPosts();
}
</script>

</body>
</html>