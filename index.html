<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{
  font-family: Arial;
  padding:20px;
  background:#f4f4f4;
  transition:0.3s;
}
.dark{
  background:#111;
  color:white;
}
.post{
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:8px;
}
.dark .post{
  background:#1e1e1e;
}
.like-btn{
  cursor:pointer;
  padding:5px 10px;
  border-radius:5px;
  border:none;
}
.liked{
  background:red;
  color:white;
}
.not-liked{
  background:#ddd;
}
button{
  margin-right:5px;
}
</style>
</head>
<body>

<button id="darkBtn">üåô Dark Mode</button>

<h2>üî• Ultimate Social App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn">Logout</button>

<hr>

<textarea id="postInput" placeholder="Write something..."></textarea>
<br><br>
<button id="postBtn">Post</button>

<div id="posts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>

document.addEventListener("DOMContentLoaded", function(){

const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;

async function init(){
  const { data } = await supabase.auth.getUser();
  currentUser = data.user;
  loadPosts();
  subscribeRealtime();
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

async function login(){
  await supabase.auth.signInWithOAuth({ provider: 'google' });
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function createPost(){
  if(!currentUser){
    alert("Login first");
    return;
  }

  const content = document.getElementById("postInput").value;
  if(!content) return;

  await supabase.from("posts").insert([{
    content: content,
    user_id: currentUser.id,
    username: currentUser.email
  }]);

  document.getElementById("postInput").value="";
}

async function deletePost(id){
  await supabase.from("posts").delete().eq("id", id);
}

async function toggleLike(postId){

  if(!currentUser){
    alert("Login first");
    return;
  }

  const { data } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id", postId)
    .eq("user_id", currentUser.id)
    .single();

  if(data){
    await supabase
      .from("likes")
      .delete()
      .eq("post_id", postId)
      .eq("user_id", currentUser.id);
  } else {
    await supabase
      .from("likes")
      .insert([{ post_id: postId, user_id: currentUser.id }]);
  }
}

async function loadPosts(){

  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  const container = document.getElementById("posts");
  container.innerHTML="";

  for(const post of posts){
    renderPost(post);
  }
}

async function renderPost(post){

  const { count } = await supabase
    .from("likes")
    .select("*",{count:"exact",head:true})
    .eq("post_id",post.id);

  let liked = false;

  if(currentUser){
    const { data } = await supabase
      .from("likes")
      .select("*")
      .eq("post_id",post.id)
      .eq("user_id",currentUser.id)
      .single();

    if(data) liked = true;
  }

  if(document.getElementById("post-"+post.id)) return;

  const div = document.createElement("div");
  div.className="post";
  div.id="post-"+post.id;

  div.innerHTML=`
    <b>${post.username || "User"}</b><br>
    ${post.content}
    <br><br>
    ‚ù§Ô∏è <span id="like-count-${post.id}">${count || 0}</span>
    <br><br>
    <button 
      class="like-btn ${liked ? "liked" : "not-liked"}"
      onclick="toggleLike('${post.id}')"
      id="like-btn-${post.id}"
    >
      ${liked ? "Unlike" : "Like"}
    </button>
    ${
      currentUser && currentUser.id===post.user_id
      ? `<button onclick="deletePost('${post.id}')">Delete</button>`
      : ""
    }
  `;

  document.getElementById("posts").prepend(div);
}

function removePost(id){
  const el = document.getElementById("post-"+id);
  if(el) el.remove();
}

function subscribeRealtime(){

  // POSTS realtime
  supabase
    .channel("posts-channel")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "posts" },
      payload => {

        if(payload.eventType === "INSERT"){
          renderPost(payload.new);
        }

        if(payload.eventType === "DELETE"){
          removePost(payload.old.id);
        }
      }
    )
    .subscribe();

  // LIKES realtime (stable refresh method)
  supabase
    .channel("likes-channel")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "likes" },
      async payload => {

        const postId = payload.new?.post_id || payload.old?.post_id;
        if(!postId) return;

        const { count } = await supabase
          .from("likes")
          .select("*",{count:"exact",head:true})
          .eq("post_id",postId);

        const countEl = document.getElementById("like-count-"+postId);
        if(countEl) countEl.textContent = count || 0;

        if(currentUser){
          const { data } = await supabase
            .from("likes")
            .select("*")
            .eq("post_id",postId)
            .eq("user_id",currentUser.id)
            .single();

          const btn = document.getElementById("like-btn-"+postId);
          if(btn){
            if(data){
              btn.classList.add("liked");
              btn.classList.remove("not-liked");
              btn.textContent="Unlike";
            }else{
              btn.classList.remove("liked");
              btn.classList.add("not-liked");
              btn.textContent="Like";
            }
          }
        }

      }
    )
    .subscribe();
}

document.getElementById("darkBtn").onclick = toggleDark;
document.getElementById("loginBtn").onclick = login;
document.getElementById("logoutBtn").onclick = logout;
document.getElementById("postBtn").onclick = createPost;

window.toggleLike = toggleLike;
window.deletePost = deletePost;

init();

});
</script>

</body>
</html>