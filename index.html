<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{font-family:Arial;padding:20px;background:#f4f4f4;transition:0.3s;}
.dark{background:#111;color:white;}
.post{background:white;padding:15px;margin-top:15px;border-radius:8px;}
.dark .post{background:#1e1e1e;}
button{margin-right:5px;margin-top:5px;}
.small{font-size:12px;opacity:0.7;}
.image-preview img{max-width:100%;margin-top:8px;border-radius:8px;}
input[type="file"]{margin-top:10px;}
</style>
</head>
<body>

<button id="darkBtn">ðŸŒ™ Dark Mode</button>

<h2>ðŸ”¥ Ultimate Social App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn">Logout</button>

<hr>

<textarea id="postInput" placeholder="Write something..."></textarea>
<br>
<input type="file" id="imageInput" multiple accept="image/*">
<br>
<button id="postBtn">Post</button>

<hr>

<div id="posts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;

/* ================= TIME FORMAT ================= */

function timeAgo(dateString){
  const now=new Date();
  const past=new Date(dateString);
  const seconds=Math.floor((now-past)/1000);
  if(seconds<60) return "Just now";
  const minutes=Math.floor(seconds/60);
  if(minutes<60) return minutes+"m ago";
  const hours=Math.floor(minutes/60);
  if(hours<24) return hours+"h ago";
  const days=Math.floor(hours/24);
  if(days<7) return days+"d ago";
  return past.toLocaleDateString();
}

/* ================= IMAGE COMPRESSION ================= */

async function compressImage(file){
  return new Promise((resolve)=>{
    const reader=new FileReader();
    reader.readAsDataURL(file);

    reader.onload=function(event){
      const img=new Image();
      img.src=event.target.result;

      img.onload=function(){

        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");

        const MAX_WIDTH=1080;

        let width=img.width;
        let height=img.height;

        if(width>MAX_WIDTH){
          height=height*(MAX_WIDTH/width);
          width=MAX_WIDTH;
        }

        canvas.width=width;
        canvas.height=height;

        ctx.drawImage(img,0,0,width,height);

        canvas.toBlob(function(blob){
          resolve(blob);
        },"image/jpeg",0.7);
      };
    };
  });
}

/* ================= IMAGE UPLOAD ================= */

async function uploadImages(files){

  const urls=[];

  for(const file of files){

    const compressed=await compressImage(file);

    const fileName=Date.now()+"-"+Math.random().toString(36).substring(2)+".jpg";

    await supabase.storage
      .from("post-images")
      .upload(fileName,compressed,{
        contentType:"image/jpeg"
      });

    const { data } = supabase.storage
      .from("post-images")
      .getPublicUrl(fileName);

    urls.push(data.publicUrl);
  }

  return urls;
}

/* ================= AUTH ================= */

async function init(){
  const { data } = await supabase.auth.getUser();
  currentUser=data.user;
  loadPosts();
  subscribeRealtime();
}

async function login(){
  await supabase.auth.signInWithOAuth({provider:'google'});
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* ================= CREATE POST ================= */

async function createPost(){

  if(!currentUser) return alert("Login first");

  const content=document.getElementById("postInput").value;
  const files=document.getElementById("imageInput").files;

  let imageUrls=[];

  if(files.length>0){
    imageUrls=await uploadImages(files);
  }

  if(!content && imageUrls.length===0) return;

  await supabase.from("posts").insert([{
    content,
    images:imageUrls,
    user_id:currentUser.id,
    username:currentUser.email
  }]);

  document.getElementById("postInput").value="";
  document.getElementById("imageInput").value="";
}

/* ================= LOAD POSTS ================= */

async function loadPosts(){

  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  document.getElementById("posts").innerHTML="";

  posts.forEach(post=>renderPost(post));
}

function renderPost(post){

  const div=document.createElement("div");
  div.className="post";

  let imagesHTML="";

  if(post.images){
    post.images.forEach(url=>{
      imagesHTML+=`<div class="image-preview"><img src="${url}"></div>`;
    });
  }

  div.innerHTML=`
    <b>${post.username}</b>
    <div class="small">${timeAgo(post.created_at)}</div>
    <div>${post.content||""}</div>
    ${imagesHTML}
  `;

  document.getElementById("posts").appendChild(div);
}

/* ================= REALTIME ================= */

function subscribeRealtime(){

  supabase.channel("posts-channel")
    .on("postgres_changes",
      {event:"INSERT",schema:"public",table:"posts"},
      payload=>renderPost(payload.new)
    )
    .subscribe();
}

/* ================= DARK MODE ================= */

function toggleDark(){
  document.body.classList.toggle("dark");
}

/* ================= BINDINGS ================= */

document.getElementById("darkBtn").onclick=toggleDark;
document.getElementById("loginBtn").onclick=login;
document.getElementById("logoutBtn").onclick=logout;
document.getElementById("postBtn").onclick=createPost;

init();

});
</script>
</body>
</html>