<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #111111;
  --subtle: #f0f2f5;
  --primary: #1877f2;
  --like: #e0245e;
  --danger: #ff4d4f;
}

.dark {
  --bg: #18191a;
  --card: #242526;
  --text: #e4e6eb;
  --subtle: #3a3b3c;
  --primary: #2d88ff;
  --like: #ff4d6d;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 15px;
}

.post {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

button {
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-weight: 500;
}

.primary { background: var(--primary); color: white; }
.danger { background: var(--danger); color: white; }
.likeBtn.liked { background: var(--like); color:white; }

.actionBar { display:flex; gap:10px; margin-top:10px; }
.comment { background: var(--subtle); padding:6px; margin-top:4px; border-radius:6px; }

</style>
</head>
<body>

<button id="themeToggle">ðŸŒ™ Dark Mode</button>
<hr>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div id="auth">
  <button id="google" class="primary">Login with Google</button>
  <button id="guest" class="primary">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout" class="danger">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea><br>
  <button id="post" class="primary">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2?dev";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

/* DARK MODE */
const themeToggle=document.getElementById("themeToggle");
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
  themeToggle.innerText="â˜€ Light Mode";
}
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const isDark=document.body.classList.contains("dark");
  localStorage.setItem("theme",isDark?"dark":"light");
  themeToggle.innerText=isDark?"â˜€ Light Mode":"ðŸŒ™ Dark Mode";
};

/* AUTH */
const { data:{ session } } = await supabase.auth.getSession();
if(session){ currentUser=session.user; showApp(); }

google.onclick=async()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};

guest.onclick=async()=>{
  const { data }=await supabase.auth.signInAnonymously();
  currentUser=data.user;
  showApp();
};

logout.onclick=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

/* CREATE POST */
post.onclick=async()=>{
  const value=text.value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  text.value="";
};

/* LOAD POSTS */
async function loadPosts(){
  const { data:posts }=await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  posts.forEach(p=>renderPost(p,false));
}

/* RENDER POST */
function renderPost(post,prepend=true){

  if(document.querySelector(`[data-id="${post.id}"]`)) return;

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <p>${post.content}</p>
    <div class="actionBar">
      ${post.user_id===currentUser.id ?
        `<button class="deleteBtn danger">Delete</button>` : ``}
    </div>
  `;

  prepend?feed.prepend(div):feed.appendChild(div);

  if(post.user_id===currentUser.id){
    div.querySelector(".deleteBtn").onclick=async()=>{
      if(confirm("Delete this post?")){
        await supabase.from("posts").delete().eq("id",post.id);
      }
    };
  }
}

/* REALTIME */
supabase.channel("realtime-feed")

.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"posts"},
  payload=>renderPost(payload.new,true)
)

.on("postgres_changes",
  {event:"DELETE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(`[data-id="${payload.old.id}"]`);
    if(el) el.remove();
  }
)

.subscribe();

</script>
</body>
</html>