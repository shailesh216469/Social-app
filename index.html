<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --text:#111;
  --primary:#1877f2;
  --danger:#ff4d4f;
  --subtle:#f0f2f5;
}
.dark{
  --bg:#18191a;
  --card:#242526;
  --text:#e4e6eb;
  --subtle:#3a3b3c;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:15px;
}
.post{
  background:var(--card);
  padding:15px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
button{
  border:none;
  border-radius:8px;
  padding:6px 12px;
  cursor:pointer;
  margin-top:5px;
}
.primary{background:var(--primary);color:white;}
.danger{background:var(--danger);color:white;}
.comment{
  background:var(--subtle);
  padding:6px;
  border-radius:6px;
  margin-top:5px;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
textarea,input{
  width:100%;
  border-radius:8px;
  padding:6px;
  margin-top:5px;
}
.actionBar{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}
</style>
</head>
<body>

<button id="themeToggle">ðŸŒ™ Dark Mode</button>
<hr>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div id="auth">
  <button id="google" class="primary">Login with Google</button>
  <button id="guest" class="primary">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout" class="danger">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea>
  <button id="post" class="primary">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;
const feed = document.getElementById("feed");

/* DARK MODE */
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
  themeToggle.innerText="â˜€ Light Mode";
}
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const isDark=document.body.classList.contains("dark");
  localStorage.setItem("theme",isDark?"dark":"light");
  themeToggle.innerText=isDark?"â˜€ Light Mode":"ðŸŒ™ Dark Mode";
};

/* AUTH SYSTEM */
const { data: { session } } = await supabase.auth.getSession();
if(session){
  currentUser = session.user;
  showApp();
}

supabase.auth.onAuthStateChange((event, session) => {
  if(session){
    currentUser = session.user;
    showApp();
  }
});

google.onclick = async () => {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.origin }
  });
};

guest.onclick = async () => {
  const { error } = await supabase.auth.signInAnonymously();
  if(error) console.log(error);
};

logout.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

/* CREATE POST */
post.onclick=async()=>{
  if(!text.value.trim()) return;
  await supabase.from("posts").insert({
    content:text.value,
    user_id:currentUser.id
  });
  text.value="";
};

/* LOAD POSTS */
async function loadPosts(){
  feed.innerHTML="";
  const { data:posts }=await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});
  posts.forEach(p=>renderPost(p));
}

/* RENDER POST */
async function renderPost(post){

  if(document.querySelector(`[data-id="${post.id}"]`)) return;

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <p>${post.content}</p>
    <div class="actionBar">
      ${post.user_id===currentUser.id?
        `<button class="danger deletePost">Delete</button>`:""}
      <button class="toggleComment">ðŸ’¬ 0</button>
    </div>
    <div class="commentSection" style="display:none;">
      <div class="comments"></div>
      <input type="text" class="commentInput" placeholder="Write comment...">
      <button class="sendComment primary">Send</button>
    </div>
  `;

  feed.prepend(div);

  /* DELETE POST */
  if(div.querySelector(".deletePost")){
    div.querySelector(".deletePost").onclick=async()=>{
      await supabase.from("posts").delete().eq("id",post.id);
    };
  }

  /* COMMENT TOGGLE */
  const toggleBtn=div.querySelector(".toggleComment");
  const commentSection=div.querySelector(".commentSection");

  toggleBtn.onclick=()=>{
    commentSection.style.display=
      commentSection.style.display==="none"?"block":"none";
  };

  /* SEND COMMENT */
  div.querySelector(".sendComment").onclick=async()=>{
    const input=div.querySelector(".commentInput");
    if(!input.value.trim()) return;
    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:input.value
    });
    input.value="";
  };

  loadComments(post.id);
}

/* LOAD COMMENTS */
del.onclick = async () => {

  const { data, error } = await supabase
    .from("comments")
    .delete()
    .eq("id", comment.id)
    .select();

  console.log("DELETE RESULT:", data);
  console.log("DELETE ERROR:", error);
};

/* REALTIME */
supabase.channel("realtime")

.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"posts"},
  payload=>renderPost(payload.new)
)

.on("postgres_changes",
  {event:"DELETE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(`[data-id="${payload.old.id}"]`);
    if(el) el.remove();
  }
)

.on("postgres_changes",
  {event:"*",schema:"public",table:"comments"},
  payload=>loadComments(payload.new?.post_id||payload.old?.post_id)
)

.subscribe();

</script>
</body>
</html>