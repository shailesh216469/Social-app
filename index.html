<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --text:#111;
  --primary:#1877f2;
  --like:#e0245e;
  --danger:#ff4d4f;
  --subtle:#f0f2f5;
}
.dark{
  --bg:#18191a;
  --card:#242526;
  --text:#e4e6eb;
  --subtle:#3a3b3c;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:15px;
}
.post{
  background:var(--card);
  padding:15px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
button{
  border:none;
  border-radius:8px;
  padding:6px 12px;
  cursor:pointer;
  margin-top:5px;
}
.primary{background:var(--primary);color:white;}
.danger{background:var(--danger);color:white;}
.likeBtn.liked{background:var(--like);color:white;}
.actionBar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.comment{
  background:var(--subtle);
  padding:6px;
  border-radius:6px;
  margin-top:5px;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
textarea,input{width:100%;border-radius:8px;padding:6px;margin-top:5px;}
</style>
</head>
<body>

<button id="themeToggle">ðŸŒ™ Dark Mode</button>
<hr>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div id="auth">
  <button id="google" class="primary">Login with Google</button>
  <button id="guest" class="primary">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout" class="danger">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea>
  <button id="post" class="primary">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2?dev";

const supabase=createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

/* AUTH */
const { data:{ session } }=await supabase.auth.getSession();
if(session){currentUser=session.user;showApp();}

google.onclick=async()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};

guest.onclick=async()=>{
  const { data }=await supabase.auth.signInAnonymously();
  currentUser=data.user;
  showApp();
};

logout.onclick=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

/* CREATE POST */
post.onclick=async()=>{
  if(!text.value.trim())return;
  await supabase.from("posts").insert({
    content:text.value,
    user_id:currentUser.id
  });
  text.value="";
};

/* LOAD POSTS */
async function loadPosts(){
  const { data:posts }=await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});
  posts.forEach(p=>renderPost(p,false));
}

/* RENDER POST */
async function renderPost(post,prepend=true){

  if(document.querySelector(`[data-id="${post.id}"]`))return;

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <p class="content">${post.content}</p>
    <div class="actionBar">
      <button class="toggleComment">ðŸ’¬ 0</button>
      ${post.user_id===currentUser.id?
        `<button class="deleteBtn danger">Delete</button>`:""}
    </div>
    <div class="commentSection" style="display:none;">
      <div class="comments"></div>
      <input type="text" class="commentInput" placeholder="Write comment...">
      <button class="sendComment primary">Send</button>
    </div>
  `;

  prepend?feed.prepend(div):feed.appendChild(div);

  setupEvents(div,post);
  loadComments(post.id);
}

/* EVENTS */
function setupEvents(div,post){

  const toggleBtn=div.querySelector(".toggleComment");
  const commentSection=div.querySelector(".commentSection");
  const input=div.querySelector(".commentInput");
  const send=div.querySelector(".sendComment");

  if(div.querySelector(".deleteBtn")){
    div.querySelector(".deleteBtn").onclick=async()=>{
      await supabase.from("posts").delete().eq("id",post.id);
    };
  }

  toggleBtn.onclick=()=>{
    commentSection.style.display=
      commentSection.style.display==="none"?"block":"none";
  };

  send.onclick=async()=>{
    if(!input.value.trim())return;
    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:input.value
    });
    input.value="";
  };
}

/* LOAD COMMENTS */
async function loadComments(postId){

  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:comments } = await supabase
    .from("comments")
    .select("*")
    .eq("post_id", postId)
    .order("created_at",{ascending:true});

  const container = postDiv.querySelector(".comments");
  container.innerHTML="";

  comments.forEach(comment => {

    const commentDiv = document.createElement("div");
    commentDiv.className="comment";

    const textSpan = document.createElement("span");
    textSpan.innerText = comment.content;

    commentDiv.appendChild(textSpan);

    // âœ… SHOW DELETE BUTTON ONLY FOR OWNER
    if(comment.user_id === currentUser.id){

      const deleteBtn = document.createElement("button");
      deleteBtn.className="danger";
      deleteBtn.innerText="X";

      deleteBtn.onclick = async () => {

        const { error } = await supabase
          .from("comments")
          .delete()
          .eq("id", comment.id);

        if(error){
          console.log("DELETE ERROR:", error);
        }
      };

      commentDiv.appendChild(deleteBtn);
    }

    container.appendChild(commentDiv);
  });

  postDiv.querySelector(".toggleComment").innerText = `ðŸ’¬ ${comments.length}`;
}

  /* DELETE COMMENT EVENT */
  container.querySelectorAll(".deleteComment").forEach(btn=>{
    btn.onclick=async()=>{
      await supabase.from("comments").delete().eq("id",btn.dataset.id);
    };
  });
}

/* REALTIME */
supabase.channel("feed")

.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"posts"},
  payload=>renderPost(payload.new,true)
)

.on("postgres_changes",
  {event:"DELETE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(`[data-id="${payload.old.id}"]`);
    if(el)el.remove();
  }
)

.on("postgres_changes",
  {event:"*",schema:"public",table:"comments"},
  payload=>loadComments(payload.new?.post_id||payload.old?.post_id)
)

.subscribe();

</script>
</body>
</html>