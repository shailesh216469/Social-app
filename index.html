<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>
<style>
body { font-family: Arial; padding:20px; }
.post { border:1px solid #ccc; padding:10px; margin-top:10px; border-radius:6px; }
.comment { margin-left:15px; font-size:14px; }
button { cursor:pointer; }
.liked { color:red; }
</style>
</head>
<body>

<h2>üî• Ultimate Social App</h2>

<div id="auth">
  <button id="google">Login Google</button>
  <button id="guest">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout">Logout</button>
  <hr>
  <textarea id="text" rows="3"></textarea><br>
  <button id="post">Post</button>
  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

const { data:{ session } }=await supabase.auth.getSession();
if(session){
  currentUser=session.user;
  showApp();
}

google.onclick=async()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};

guest.onclick=async()=>{
  const { data }=await supabase.auth.signInAnonymously();
  currentUser=data.user;
  showApp();
};

logout.onclick=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

post.onclick=async()=>{
  const value=text.value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  text.value="";
};

async function loadPosts(){
  const { data:posts }=await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  feed.innerHTML="";
  for(const post of posts){
    await renderPost(post);
  }
}

async function renderPost(post){

  const { data:likes }=await supabase
    .from("likes")
    .select("*")
    .eq("post_id",post.id)
    .eq("active",true);

  const likeCount=likes.length;
  const likedByMe=likes.some(l=>l.user_id===currentUser.id);

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <p>${post.content}</p>
    <button class="likeBtn ${likedByMe?"liked":""}">
      ‚ù§Ô∏è ${likeCount}
    </button>

    <div class="comments"></div>
    <input type="text" class="commentInput" placeholder="Write comment..." />
    <button class="sendComment">Send</button>
  `;

  feed.appendChild(div);

  const likeBtn=div.querySelector(".likeBtn");

  likeBtn.onclick=async()=>{

    const { data:existing }=await supabase
      .from("likes")
      .select("*")
      .eq("post_id",post.id)
      .eq("user_id",currentUser.id)
      .single();

    if(existing){
      await supabase
        .from("likes")
        .update({active:!existing.active})
        .eq("id",existing.id);
    }else{
      await supabase.from("likes").insert({
        post_id:post.id,
        user_id:currentUser.id,
        active:true
      });
    }
  };

  const input=div.querySelector(".commentInput");
  const send=div.querySelector(".sendComment");

  send.onclick=async()=>{
    const value=input.value.trim();
    if(!value) return;

    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:value
    });

    input.value="";
  };

  loadComments(post.id);
}

async function loadComments(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:comments }=await supabase
    .from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});

  const container=postDiv.querySelector(".comments");
  container.innerHTML="";

  comments.forEach(c=>{
    const div=document.createElement("div");
    div.className="comment";
    div.innerText=c.content;
    container.appendChild(div);
  });
}

supabase.channel("realtime")
.on("postgres_changes",{event:"*",schema:"public",table:"posts"},()=>loadPosts())
.on("postgres_changes",{event:"*",schema:"public",table:"likes"},()=>loadPosts())
.on("postgres_changes",{event:"*",schema:"public",table:"comments"},
  payload=>loadComments(payload.new?.post_id || payload.old?.post_id)
)
.subscribe();

</script>
</body>
</html>