<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #111111;
  --subtle: #f0f2f5;
  --primary: #1877f2;
  --like: #e0245e;
}

.dark {
  --bg: #18191a;
  --card: #242526;
  --text: #e4e6eb;
  --subtle: #3a3b3c;
  --primary: #2d88ff;
  --like: #ff4d6d;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 15px;
  transition: background 0.3s ease, color 0.3s ease;
}

.post {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: background 0.3s ease;
}

textarea {
  width: 100%;
  border-radius: 8px;
  padding: 10px;
  border: 1px solid #ccc;
  resize: none;
  background: var(--card);
  color: var(--text);
}

button {
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  background: var(--primary);
  color: white;
  font-weight: 500;
  cursor: pointer;
  transition: 0.2s;
}

button:hover { opacity: 0.9; }

.actionBar {
  display: flex;
  gap: 12px;
  margin-top: 10px;
}

.likeBtn.liked {
  background: var(--like);
}

.commentSection { margin-top: 10px; }

.comment {
  background: var(--subtle);
  padding: 6px 10px;
  border-radius: 6px;
  margin-top: 5px;
  font-size: 14px;
}

/* ‚ù§Ô∏è Like Animation */
@keyframes popLike {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.4); }
  100% { transform: scale(1); }
}

.likeBtn.animate {
  animation: popLike 0.3s ease;
}
</style>
</head>

<body>

<button id="themeToggle">üåô Dark Mode</button>
<hr>

<h2>üî• Ultimate Social App</h2>

<div id="auth">
  <button id="google">Login with Google</button>
  <button id="guest">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea><br>
  <button id="post">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">

import { createClient } from "https://esm.sh/@supabase/supabase-js@2?dev";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

/* ===== DARK MODE ===== */

const themeToggle = document.getElementById("themeToggle");

if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
  themeToggle.innerText="‚òÄ Light Mode";
}

themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const isDark=document.body.classList.contains("dark");
  localStorage.setItem("theme",isDark?"dark":"light");
  themeToggle.innerText=isDark?"‚òÄ Light Mode":"üåô Dark Mode";
};

/* ===== AUTH ===== */

const { data:{ session } } = await supabase.auth.getSession();

if(session){
  currentUser=session.user;
  showApp();
}

google.onclick=async()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};

guest.onclick=async()=>{
  const { data }=await supabase.auth.signInAnonymously();
  currentUser=data.user;
  showApp();
};

logout.onclick=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadInitialPosts();
}

/* ===== CREATE POST ===== */

post.onclick=async()=>{
  const value=text.value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  text.value="";
};

/* ===== INITIAL LOAD ===== */

async function loadInitialPosts(){
  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  posts.forEach(post=>{
    renderPost(post,false);
  });
}

/* ===== RENDER POST ===== */

async function renderPost(post, prepend=true){

  if(document.querySelector(`[data-id="${post.id}"]`)) return;

  const { data:likes }=await supabase
    .from("likes")
    .select("*")
    .eq("post_id",post.id)
    .eq("active",true);

  const likeCount=likes.length;
  const likedByMe=likes.some(l=>l.user_id===currentUser.id);

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <p>${post.content}</p>

    <div class="actionBar">
      <button class="likeBtn ${likedByMe?"liked":""}">
        ‚ù§Ô∏è ${likeCount}
      </button>
      <button class="toggleComment">üí¨ Comment</button>
    </div>

    <div class="commentSection" style="display:none;">
      <div class="comments"></div>
      <input type="text" class="commentInput" placeholder="Write comment..." />
      <button class="sendComment">Send</button>
    </div>
  `;

  if(prepend){
    feed.prepend(div);
  } else {
    feed.appendChild(div);
  }

  setupPostEvents(div, post);
  loadComments(post.id);
}

/* ===== EVENTS ===== */

function setupPostEvents(div, post){

  const likeBtn=div.querySelector(".likeBtn");
  const toggleBtn=div.querySelector(".toggleComment");
  const commentSection=div.querySelector(".commentSection");
  const input=div.querySelector(".commentInput");
  const send=div.querySelector(".sendComment");

  toggleBtn.onclick=()=>{
    commentSection.style.display=
      commentSection.style.display==="none"?"block":"none";
  };

  likeBtn.onclick=async()=>{

    const { data:existing }=await supabase
      .from("likes")
      .select("*")
      .eq("post_id",post.id)
      .eq("user_id",currentUser.id)
      .maybeSingle();

    if(existing){

      const newState = !existing.active;

      await supabase
        .from("likes")
        .update({active:newState})
        .eq("id",existing.id);

      if(newState){
        likeBtn.classList.add("animate");
        setTimeout(()=>likeBtn.classList.remove("animate"),300);
      }

    }else{

      await supabase.from("likes").insert({
        post_id:post.id,
        user_id:currentUser.id,
        active:true
      });

      likeBtn.classList.add("animate");
      setTimeout(()=>likeBtn.classList.remove("animate"),300);
    }
  };

  send.onclick=async()=>{
    const value=input.value.trim();
    if(!value) return;

    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:value
    });

    input.value="";
  };
}

/* ===== COMMENTS ===== */

async function loadComments(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:comments }=await supabase
    .from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});

  const container=postDiv.querySelector(".comments");
  container.innerHTML="";

  comments.forEach(c=>{
    const div=document.createElement("div");
    div.className="comment";
    div.innerText=c.content;
    container.appendChild(div);
  });
}

/* ===== UPDATE LIKE UI ===== */

async function updateLikeUI(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:likes }=await supabase
    .from("likes")
    .select("*")
    .eq("post_id",postId)
    .eq("active",true);

  const likeBtn=postDiv.querySelector(".likeBtn");

  const likeCount=likes.length;
  const likedByMe=likes.some(l=>l.user_id===currentUser.id);

  likeBtn.innerHTML=`‚ù§Ô∏è ${likeCount}`;
  likeBtn.classList.toggle("liked",likedByMe);
}

/* ===== REALTIME ===== */

const channel = supabase.channel("realtime-feed");

channel
.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"posts"},
  payload=>renderPost(payload.new,true)
)
.on("postgres_changes",
  {event:"*",schema:"public",table:"likes"},
  payload=>updateLikeUI(payload.new?.post_id || payload.old?.post_id)
)
.on("postgres_changes",
  {event:"*",schema:"public",table:"comments"},
  payload=>loadComments(payload.new?.post_id || payload.old?.post_id)
)
.subscribe(status=>{
  console.log("Realtime status:",status);
});

</script>
</body>
</html>