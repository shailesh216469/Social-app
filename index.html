<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App v3.5</title>

<style>
body{font-family:system-ui;background:#f3f4f6;padding:20px;transition:.3s;}
.dark{background:#0f0f0f;color:white;}
.card{background:white;padding:16px;border-radius:14px;margin-top:18px;box-shadow:0 3px 15px rgba(0,0,0,.06);}
.dark .card{background:#1c1c1c;}
button{padding:6px 10px;border:none;border-radius:8px;cursor:pointer;margin-right:5px;margin-top:5px;font-size:13px;}
.primary{background:#4f46e5;color:white;}
.danger{background:#ef4444;color:white;}
textarea{width:100%;padding:8px;border-radius:10px;margin-top:5px;font-size:14px;}
.comment-box{margin-top:8px;padding-left:8px;border-left:2px solid #ddd;font-size:13px;}
.image-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:8px;}
.image-grid img{width:100%;height:110px;object-fit:cover;border-radius:8px;}
.overlay{
 position:absolute;top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,.5);
 color:white;display:flex;align-items:center;
 justify-content:center;font-size:20px;border-radius:8px;
}
.small{font-size:12px;color:#777;}
</style>
</head>
<body>

<h2>ðŸ”¥ Ultimate Social App v3.5</h2>

<div>
<span id="userEmail"></span>
<button id="googleBtn" class="primary">Google</button>
<button id="guestBtn">Guest</button>
<button id="logoutBtn">Logout</button>
<button id="darkBtn">ðŸŒ™</button>
</div>

<div class="card">
<textarea id="postInput" placeholder="Write something..."></textarea>
<input type="file" id="imageInput" multiple accept="image/*">
<button id="postBtn" class="primary">Post</button>
</div>

<div id="feed"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const supabase = window.supabase.createClient(
"https://dgehzagvyrxbnnvgsiff.supabase.co",
"sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let user=null;

/* ================= AUTH ================= */

async function init(){
 const {data}=await supabase.auth.getUser();
 user=data.user;
 updateUserUI();

 supabase.auth.onAuthStateChange((e,s)=>{
  user=s?.user||null;
  updateUserUI();
 });

 await loadPosts();
 subscribeRealtime();
}

function updateUserUI(){
 userEmail.innerText =
 user ? "Logged in: "+(user.email||"Guest") : "Not logged in";
}

googleBtn.onclick=()=>supabase.auth.signInWithOAuth({provider:"google"});
guestBtn.onclick=async()=>{
 const {data}=await supabase.auth.signInAnonymously();
 user=data.user;
 updateUserUI();
};
logoutBtn.onclick=async()=>{
 await supabase.auth.signOut();
 location.reload();
};

/* ================= CREATE POST ================= */

postBtn.onclick=async()=>{
 if(!user)return alert("Login first");

 const content=postInput.value.trim();
 const files=imageInput.files;

 if(!content && files.length===0){
  alert("Post cannot be empty");
  return;
 }

 let urls=[];

 for(const f of files){
  const name=Date.now()+"-"+Math.random()+".jpg";
  await supabase.storage.from("post-images").upload(name,f);
  const {data}=supabase.storage.from("post-images").getPublicUrl(name);
  urls.push(data.publicUrl);
 }

 await supabase.from("posts")
  .insert([{content,images:urls,user_id:user.id,username:user.email}]);

 postInput.value="";
 imageInput.value="";
};

/* ================= LOAD POSTS ================= */

async function loadPosts(){
 feed.innerHTML="";
 const {data}=await supabase.from("posts")
  .select("*")
  .order("created_at",{ascending:false});
 data?.forEach(renderPost);
}

/* ================= RENDER POST ================= */

function renderPost(post){

 if(document.getElementById("post-"+post.id))return;

 let grid="";
 if(post.images && post.images.length){
  const visible=post.images.slice(0,3);
  const extra=post.images.length-3;

  grid=`<div class="image-grid">`;

  visible.forEach((u,i)=>{
   if(i===2 && extra>0){
    grid+=`
     <div style="position:relative">
      <img src="${u}">
      <div class="overlay">+${extra}</div>
     </div>
    `;
   }else{
    grid+=`<img src="${u}">`;
   }
  });

  grid+=`</div>`;
 }

 const div=document.createElement("div");
 div.className="card";
 div.id="post-"+post.id;

 div.innerHTML=`
  <b>${post.username}</b>
  <div id="post-text-${post.id}">${post.content||""}</div>

  ${
   user && String(user.id)===String(post.user_id)
   ? `<button onclick="editPost('${post.id}')">Edit</button>
      <button class="danger" onclick="deletePost('${post.id}')">Delete</button>`
   : ""
  }

  ${grid}

  <div id="comments-${post.id}"></div>
  <textarea id="comment-input-${post.id}" placeholder="Comment..."></textarea>
  <button onclick="addComment('${post.id}')">Send</button>
 `;

 feed.appendChild(div);
 loadComments(post.id);
}

/* ================= DELETE POST ================= */

window.deletePost=async id=>{
 const {data}=await supabase.from("posts")
  .select("images")
  .eq("id",id)
  .single();

 if(data?.images){
  for(const url of data.images){
   const path=url.split("/post-images/")[1];
   if(path){
    await supabase.storage.from("post-images").remove([path]);
   }
  }
 }

 await supabase.from("posts").delete().eq("id",id);
};

/* ================= EDIT POST ================= */

window.editPost=async id=>{
 const {data}=await supabase.from("posts")
  .select("*")
  .eq("id",id)
  .single();

 const post=document.getElementById("post-"+id);

 let currentImages="";
 data.images?.forEach(u=>{
  currentImages+=`<img src="${u}" style="width:70px;height:70px;object-fit:cover;margin:4px;border-radius:6px;">`;
 });

 post.innerHTML=`
  <textarea id="edit-text-${id}">${data.content}</textarea>
  <div>${currentImages}</div>
  <input type="file" id="edit-img-${id}" multiple>
  <button onclick="savePost('${id}')">Save</button>
  <button onclick="loadPosts()">Cancel</button>
 `;
};

window.savePost=async id=>{
 const text=document.getElementById("edit-text-"+id).value;
 const files=document.getElementById("edit-img-"+id).files;

 let urls=[];

 for(const f of files){
  const name=Date.now()+"-"+Math.random()+".jpg";
  await supabase.storage.from("post-images").upload(name,f);
  const {data}=supabase.storage.from("post-images").getPublicUrl(name);
  urls.push(data.publicUrl);
 }

 await supabase.from("posts")
  .update({content:text,images:urls})
  .eq("id",id);
};

/* ================= COMMENTS ================= */

window.addComment=async postId=>{
 const input=document.getElementById("comment-input-"+postId);
 if(!input.value)return;

 await supabase.from("comments")
  .insert([{post_id:postId,user_id:user.id,
    username:user.email,content:input.value}]);

 input.value="";
};

async function loadComments(postId){
 const {data}=await supabase.from("comments")
  .select("*")
  .eq("post_id",postId)
  .order("created_at",{ascending:true});

 const box=document.getElementById("comments-"+postId);
 box.innerHTML="";

 data?.forEach(c=>{
  box.innerHTML+=`
   <div class="comment-box" id="comment-${c.id}">
    <b>${c.username}</b>: ${c.content}
    ${
     user && String(user.id)===String(c.user_id)
     ? `<button onclick="deleteComment('${c.id}')">Delete</button>`
     : ""
    }
   </div>
  `;
 });
}

window.deleteComment=async id=>{
 await supabase.from("comments").delete().eq("id",id);
};

/* ================= REALTIME ================= */

function subscribeRealtime(){

 supabase.channel("posts")
  .on("postgres_changes",{event:"*",schema:"public",table:"posts"},
   ()=>loadPosts())
  .subscribe();

 supabase.channel("comments")
  .on("postgres_changes",{event:"*",schema:"public",table:"comments"},
   p=>{
    const id=p.new?.post_id||p.old?.post_id;
    if(id)loadComments(id);
   })
  .subscribe();
}

darkBtn.onclick=()=>document.body.classList.toggle("dark");

init();
});
</script>
</body>
</html>