<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>
<style>
body { font-family: Arial; padding: 20px; }
.post { border:1px solid #ccc; padding:10px; margin-top:10px; border-radius:6px; }
.comment { margin-left:15px; font-size:14px; }
.commentBox { margin-top:8px; }
.deleteBtn { background:red; color:white; border:none; padding:3px 6px; }
</style>
</head>
<body>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div id="auth">
  <button id="google">Login Google</button>
  <button id="guest">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout">Logout</button>
  <hr>
  <textarea id="text" rows="3"></textarea><br>
  <button id="post">Post</button>
  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;
const feed = document.getElementById("feed");

const { data:{ session } } = await supabase.auth.getSession();
if(session){
  currentUser = session.user;
  showApp();
}

google.onclick = async ()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};

guest.onclick = async ()=>{
  const { data } = await supabase.auth.signInAnonymously();
  currentUser = data.user;
  showApp();
};

logout.onclick = async ()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

post.onclick = async ()=>{
  const value=text.value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  text.value="";
};

async function loadPosts(){
  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  feed.innerHTML="";
  for(const post of posts){
    await renderPost(post);
  }
}

async function renderPost(post){

  const div=document.createElement("div");
  div.className="post";
  div.setAttribute("data-id",post.id);

  div.innerHTML=`<p>${post.content}</p>
  <div class="comments"></div>
  <div class="commentBox">
    <input type="text" placeholder="Write comment..." />
    <button>Send</button>
  </div>`;

  feed.appendChild(div);

  const commentInput=div.querySelector("input");
  const sendBtn=div.querySelector(".commentBox button");

  sendBtn.onclick=async ()=>{
    const value=commentInput.value.trim();
    if(!value) return;

    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:value
    });

    commentInput.value="";
  };

  loadComments(post.id);
}

async function loadComments(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:comments } = await supabase
    .from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});

  const container=postDiv.querySelector(".comments");
  container.innerHTML="";

  for(const comment of comments){
    const c=document.createElement("div");
    c.className="comment";

    c.innerHTML=`${comment.content}
    ${comment.user_id===currentUser.id?
      '<button class="deleteBtn">x</button>':""}`;

    container.appendChild(c);

    if(comment.user_id===currentUser.id){
      c.querySelector(".deleteBtn").onclick=async ()=>{
        await supabase
          .from("comments")
          .delete()
          .eq("id",comment.id);
      };
    }
  }
}


// REALTIME

supabase.channel("realtime")
  .on("postgres_changes",
      {event:"INSERT",schema:"public",table:"posts"},
      (payload)=>renderPost(payload.new)
  )
  .on("postgres_changes",
      {event:"INSERT",schema:"public",table:"comments"},
      (payload)=>loadComments(payload.new.post_id)
  )
  .on("postgres_changes",
      {event:"DELETE",schema:"public",table:"comments"},
      (payload)=>loadComments(payload.old.post_id)
  )
  .subscribe();

</script>
</body>
</html>