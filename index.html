<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body{
  font-family: Arial;
  padding:20px;
  background:#f4f4f4;
  transition:0.3s;
}
.dark{
  background:#111;
  color:white;
}
.post{
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:8px;
}
.dark .post{
  background:#1e1e1e;
}
.like-btn{
  cursor:pointer;
  padding:5px 10px;
  border-radius:5px;
  border:none;
}
.liked{
  background:red;
  color:white;
}
.not-liked{
  background:#ddd;
}
button{
  margin-right:5px;
  margin-top:5px;
}
.edit-area{
  width:100%;
  margin-top:5px;
}
.small{
  font-size:12px;
  opacity:0.7;
}
</style>
</head>
<body>

<button id="darkBtn">üåô Dark Mode</button>

<h2>üî• Ultimate Social App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn">Logout</button>

<hr>

<textarea id="postInput" placeholder="Write something..."></textarea>
<br><br>
<button id="postBtn">Post</button>

<div id="posts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

const supabase = window.supabase.createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser = null;

function timeAgo(dateString){

  const now = new Date();
  const past = new Date(dateString);
  const seconds = Math.floor((now - past) / 1000);

  if(seconds < 60) return "Just now";

  const minutes = Math.floor(seconds / 60);
  if(minutes < 60) return minutes + "m ago";

  const hours = Math.floor(minutes / 60);
  if(hours < 24) return hours + "h ago";

  const days = Math.floor(hours / 24);
  if(days < 7) return days + "d ago";

  return past.toLocaleDateString(undefined,{
    day:"2-digit",
    month:"short",
    year:"numeric"
  });
}

async function init(){
  const { data } = await supabase.auth.getUser();
  currentUser = data.user;
  loadPosts();
  subscribeRealtime();
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

async function login(){
  await supabase.auth.signInWithOAuth({ provider: 'google' });
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function createPost(){
  if(!currentUser){
    alert("Login first");
    return;
  }

  const content = document.getElementById("postInput").value;
  if(!content) return;

  await supabase.from("posts").insert([{
    content: content,
    user_id: currentUser.id,
    username: currentUser.email
  }]);

  document.getElementById("postInput").value="";
}

async function deletePost(id){
  await supabase.from("posts").delete().eq("id", id);
}

async function toggleLike(postId){

  if(!currentUser){
    alert("Login first");
    return;
  }

  const { data } = await supabase
    .from("likes")
    .select("*")
    .eq("post_id", postId)
    .eq("user_id", currentUser.id)
    .maybeSingle();

  if(data){
    await supabase
      .from("likes")
      .update({ active: !data.active })
      .eq("id", data.id);
  } else {
    await supabase
      .from("likes")
      .insert([{
        post_id: postId,
        user_id: currentUser.id,
        active: true
      }]);
  }
}

async function loadPosts(){
  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  document.getElementById("posts").innerHTML="";

  for(const post of posts){
    renderPost(post);
  }
}

async function renderPost(post){

  const { count } = await supabase
    .from("likes")
    .select("*",{count:"exact",head:true})
    .eq("post_id",post.id)
    .eq("active",true);

  let liked = false;

  if(currentUser){
    const { data } = await supabase
      .from("likes")
      .select("*")
      .eq("post_id",post.id)
      .eq("user_id",currentUser.id)
      .eq("active",true)
      .maybeSingle();

    if(data) liked = true;
  }

  if(document.getElementById("post-"+post.id)) return;

  const timeText =
    post.updated_at && post.updated_at !== post.created_at
      ? "Edited ‚Ä¢ " + timeAgo(post.updated_at)
      : timeAgo(post.created_at);

  const div = document.createElement("div");
  div.className="post";
  div.id="post-"+post.id;

  div.dataset.created = post.created_at;
  div.dataset.updated = post.updated_at;

  div.innerHTML=`
    <b>${post.username || "User"}</b>
    <div class="small">${timeText}</div>
    <div class="content">${post.content}</div>

    <br>
    ‚ù§Ô∏è <span id="like-count-${post.id}">${count || 0}</span>
    <br><br>

    <button 
      class="like-btn ${liked ? "liked" : "not-liked"}"
      onclick="toggleLike('${post.id}')"
      id="like-btn-${post.id}"
    >
      ${liked ? "Unlike" : "Like"}
    </button>

    ${
      currentUser && currentUser.id===post.user_id
      ? `
        <button onclick="startEdit('${post.id}')">Edit</button>
        <button onclick="deletePost('${post.id}')">Delete</button>
      `
      : ""
    }

    <div id="edit-box-${post.id}"></div>
  `;

  document.getElementById("posts").prepend(div);
}

function startEdit(postId){

  const contentDiv = document.querySelector("#post-"+postId+" .content");
  const oldText = contentDiv.innerText;

  const editBox = document.getElementById("edit-box-"+postId);

  editBox.innerHTML = `
    <textarea class="edit-area" id="edit-input-${postId}">${oldText}</textarea>
    <button onclick="saveEdit('${postId}')">Save</button>
    <button onclick="cancelEdit('${postId}')">Cancel</button>
  `;
}

function cancelEdit(postId){
  document.getElementById("edit-box-"+postId).innerHTML="";
}

async function saveEdit(postId){

  const newText = document.getElementById("edit-input-"+postId).value;
  if(!newText) return;

  await supabase
    .from("posts")
    .update({ content: newText })
    .eq("id", postId);

  document.getElementById("edit-box-"+postId).innerHTML="";
}

function removePost(id){
  const el = document.getElementById("post-"+id);
  if(el) el.remove();
}

function subscribeRealtime(){

  supabase
    .channel("posts-channel")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "posts" },
      payload => {

        if(payload.eventType === "INSERT"){
          renderPost(payload.new);
        }

        if(payload.eventType === "DELETE"){
          removePost(payload.old.id);
        }

        if(payload.eventType === "UPDATE"){
          const postDiv = document.getElementById("post-"+payload.new.id);
          if(postDiv){
            postDiv.querySelector(".content").innerText = payload.new.content;

            postDiv.dataset.updated = payload.new.updated_at;

            postDiv.querySelector(".small").innerText =
              "Edited ‚Ä¢ " + timeAgo(payload.new.updated_at);
          }
        }
      }
    )
    .subscribe();

  supabase
    .channel("likes-channel")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "likes" },
      async payload => {

        const postId = payload.new?.post_id || payload.old?.post_id;
        if(!postId) return;

        const { count } = await supabase
          .from("likes")
          .select("*",{count:"exact",head:true})
          .eq("post_id",postId)
          .eq("active",true);

        const countEl = document.getElementById("like-count-"+postId);
        if(countEl) countEl.textContent = count || 0;
      }
    )
    .subscribe();
}

setInterval(() => {

  const posts = document.querySelectorAll(".post");

  posts.forEach(post => {

    const created = post.dataset.created;
    const updated = post.dataset.updated;
    const timeDiv = post.querySelector(".small");

    if(updated && updated !== created){
      timeDiv.innerText = "Edited ‚Ä¢ " + timeAgo(updated);
    }else{
      timeDiv.innerText = timeAgo(created);
    }

  });

}, 30000);

document.getElementById("darkBtn").onclick = toggleDark;
document.getElementById("loginBtn").onclick = login;
document.getElementById("logoutBtn").onclick = logout;
document.getElementById("postBtn").onclick = createPost;

window.toggleLike = toggleLike;
window.deletePost = deletePost;
window.startEdit = startEdit;
window.saveEdit = saveEdit;
window.cancelEdit = cancelEdit;

init();

});
</script>

</body>
</html>