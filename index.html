<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
:root{
  --bg:#f0f2f5;
  --card:#fff;
  --text:#111;
  --primary:#1877f2;
  --danger:#ff4d4f;
  --subtle:#f0f2f5;
  --like:#e0245e;
}
.dark{
  --bg:#18191a;
  --card:#242526;
  --text:#e4e6eb;
  --subtle:#3a3b3c;
}
body{
  font-family:sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:15px;
  transition:.3s;
}
.post{
  background:var(--card);
  padding:15px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.userLine{
  font-size:13px;
  opacity:.7;
  margin-bottom:6px;
}
button{
  border:none;
  border-radius:8px;
  padding:6px 12px;
  cursor:pointer;
  margin-top:5px;
}
.primary{background:var(--primary);color:white;}
.danger{background:var(--danger);color:white;}
.likeBtn.liked{background:var(--like);color:white;}
.comment{
  background:var(--subtle);
  padding:6px;
  border-radius:6px;
  margin-top:5px;
}
textarea,input{
  width:100%;
  padding:6px;
  border-radius:8px;
  margin-top:5px;
}
.badge{
  background:var(--primary);
  color:white;
  padding:2px 6px;
  border-radius:12px;
  font-size:12px;
}
</style>
</head>
<body>

<button id="themeToggle">üåô</button>
<hr>
<h2>üî• Ultimate Social App</h2>

<div id="auth">
  <button id="google" class="primary">Login with Google</button>
  <button id="guest" class="primary">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout" class="danger">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea>
  <button id="post" class="primary">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase=createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

/* AUTH */
const { data:{ session } }=await supabase.auth.getSession();
if(session){currentUser=session.user;startApp();}
supabase.auth.onAuthStateChange((e,s)=>{
  if(s){currentUser=s.user;startApp();}
});

function startApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

/* LOAD POSTS */
async function loadPosts(){
  const { data }=await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});
  feed.innerHTML="";
  data.forEach(p=>renderPost(p));
}

/* TIME FORMAT */
function formatTime(post){
  if(post.updated_at && post.updated_at !== post.created_at){
    return "Edited ‚Ä¢ "+new Date(post.updated_at).toLocaleString();
  }
  return new Date(post.created_at).toLocaleString();
}

/* RENDER POST */
function renderPost(post){

  if(document.querySelector(`[data-id="${post.id}"]`)) return;

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <div class="userLine">
      üë§ ${post.username} ‚Ä¢ 
      <span class="time">${formatTime(post)}</span>
    </div>
    <div class="content">${post.content}</div>
    <div class="actions">
      <button class="likeBtn">‚ù§Ô∏è 0</button>
      <button class="commentToggle">üí¨</button>
      ${post.user_id===currentUser.id?
        `<button class="editBtn primary">Edit</button>
         <button class="deleteBtn danger">Delete</button>`:""}
    </div>
  `;

  feed.prepend(div);

  /* DELETE POST */
  div.querySelector(".deleteBtn")?.addEventListener("click",async()=>{
    await supabase.from("posts").delete().eq("id",post.id);
  });

  /* INLINE EDIT */
  div.querySelector(".editBtn")?.addEventListener("click",()=>{
    const contentDiv=div.querySelector(".content");
    const oldText=contentDiv.innerText;

    contentDiv.innerHTML=`
      <textarea class="editArea">${oldText}</textarea>
      <button class="saveEdit primary">Save</button>
      <button class="cancelEdit danger">Cancel</button>
    `;

    div.querySelector(".cancelEdit").onclick=()=>{
      contentDiv.innerText=oldText;
    };

    div.querySelector(".saveEdit").onclick=async()=>{
      const newText=div.querySelector(".editArea").value;
      if(!newText.trim()) return;

      await supabase.from("posts")
        .update({
          content:newText,
          updated_at:new Date().toISOString()
        })
        .eq("id",post.id);

      contentDiv.innerText=newText;
      div.querySelector(".time").innerText="Edited ‚Ä¢ just now";
    };
  });
}

/* REALTIME */
supabase.channel("live")
.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"posts"},
  payload=>renderPost(payload.new)
)
.on("postgres_changes",
  {event:"DELETE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(
      `[data-id="${payload.old.id}"]`
    );
    if(el) el.remove();
  }
)
.on("postgres_changes",
  {event:"UPDATE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(
      `[data-id="${payload.new.id}"]`
    );
    if(el){
      el.querySelector(".content").innerText=payload.new.content;
      el.querySelector(".time").innerText=
        "Edited ‚Ä¢ "+new Date(payload.new.updated_at).toLocaleString();
    }
  }
)
.subscribe();

</script>
</body>
</html>