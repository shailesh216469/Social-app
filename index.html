<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Ultimate Social App</title>
<style>
body { font-family: Arial; padding:20px; background:#f2f2f2; }
#appSection { display:none; }
button { margin:5px; padding:8px 12px; cursor:pointer; }
textarea { width:100%; padding:10px; }
.post {
  background:white;
  padding:15px;
  margin:10px 0;
  border-radius:8px;
}
.small { font-size:12px; color:gray; }
</style>
</head>
<body>

<h2>ðŸ”¥ Ultimate Social App</h2>

<div id="authSection">
  <button id="googleBtn">Login with Google</button>
  <button id="guestBtn">Guest Login</button>
</div>

<div id="appSection">

  <p>Logged in as: <b id="userInfo"></b></p>
  <button id="logoutBtn">Logout</button>

  <hr>

  <h3>Create Post</h3>
  <textarea id="postInput" rows="3" placeholder="What's on your mind?"></textarea>
  <br>
  <button id="postBtn">Post</button>

  <hr>

  <h3>Feed</h3>
  <div id="postsContainer"></div>

</div>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

const googleBtn = document.getElementById("googleBtn");
const guestBtn = document.getElementById("guestBtn");
const logoutBtn = document.getElementById("logoutBtn");
const postBtn = document.getElementById("postBtn");

const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");
const userInfo = document.getElementById("userInfo");
const postsContainer = document.getElementById("postsContainer");

/* ================= AUTH ================= */

googleBtn.addEventListener("click", async () => {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.origin }
  });
});

guestBtn.addEventListener("click", async () => {
  await supabase.auth.signInAnonymously();
});

logoutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
});

/* ================= SESSION CHECK ================= */

async function checkUser() {
  const { data } = await supabase.auth.getSession();

  if (data.session) {
    authSection.style.display = "none";
    appSection.style.display = "block";
    userInfo.innerText = data.session.user.email || "Guest";
    loadPosts();
  } else {
    authSection.style.display = "block";
    appSection.style.display = "none";
  }
}

supabase.auth.onAuthStateChange(() => {
  checkUser();
});

checkUser();

/* ================= CREATE POST ================= */

postBtn.addEventListener("click", async () => {

  const content = document.getElementById("postInput").value.trim();
  if (!content) return;

  const { data: { user } } = await supabase.auth.getUser();

  const { error } = await supabase
    .from("posts")
    .insert([{ content: content, user_id: user.id }]);

  if (!error) {
    document.getElementById("postInput").value = "";
  } else {
    console.log(error);
  }
});

/* ================= LOAD POSTS ================= */

async function loadPosts() {

  postsContainer.innerHTML = "";

  const { data: posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  posts.forEach(post => {
    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <p>${post.content}</p>
      <div class="small">${new Date(post.created_at).toLocaleString()}</div>
    `;
    postsContainer.appendChild(div);
  });
}

/* ================= REALTIME ================= */

supabase
  .channel("realtime-posts")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "posts" },
    () => {
      loadPosts();
    }
  )
  .subscribe();

</script>

</body>
</html>