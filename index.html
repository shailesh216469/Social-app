<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
body { font-family: Arial; padding:20px; background:#f5f5f5; }
.post {
  background:white;
  border-radius:8px;
  padding:12px;
  margin-top:12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
.actionBar { display:flex; gap:15px; margin-top:10px; }
.likeBtn.liked { color:red; font-weight:bold; }
.commentSection { margin-top:10px; }
.comment { font-size:14px; margin-left:10px; margin-top:4px; }
button { cursor:pointer; }
</style>
</head>

<body>

<h2>üî• Ultimate Social App</h2>

<div id="auth">
  <button id="google">Login with Google</button>
  <button id="guest">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea><br>
  <button id="post">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2?dev";
const supabase = createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

const { data:{ session } } = await supabase.auth.getSession();
if(session){
  currentUser=session.user;
  showApp();
}

google.onclick=async()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};

guest.onclick=async()=>{
  const { data }=await supabase.auth.signInAnonymously();
  currentUser=data.user;
  showApp();
};

logout.onclick=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

post.onclick=async()=>{
  const value=text.value.trim();
  if(!value) return;

  await supabase.from("posts").insert({
    content:value,
    user_id:currentUser.id
  });

  text.value="";
};

async function loadPosts(){
  const { data:posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  feed.innerHTML="";
  for(const post of posts){
    await renderPost(post);
  }
}

async function renderPost(post){

  const { data:likes }=await supabase
    .from("likes")
    .select("*")
    .eq("post_id",post.id)
    .eq("active",true);

  const likeCount=likes.length;
  const likedByMe=likes.some(l=>l.user_id===currentUser.id);

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <p>${post.content}</p>

    <div class="actionBar">
      <button class="likeBtn ${likedByMe?"liked":""}">
        ‚ù§Ô∏è ${likeCount}
      </button>
      <button class="toggleComment">üí¨ Comment</button>
    </div>

    <div class="commentSection" style="display:none;">
      <div class="comments"></div>
      <input type="text" class="commentInput" placeholder="Write comment..." />
      <button class="sendComment">Send</button>
    </div>
  `;

  feed.appendChild(div);

  const likeBtn=div.querySelector(".likeBtn");
  const toggleBtn=div.querySelector(".toggleComment");
  const commentSection=div.querySelector(".commentSection");
  const input=div.querySelector(".commentInput");
  const send=div.querySelector(".sendComment");

  toggleBtn.onclick=()=>{
    commentSection.style.display=
      commentSection.style.display==="none"?"block":"none";
  };

  likeBtn.onclick=async()=>{

    const { data:existing }=await supabase
      .from("likes")
      .select("*")
      .eq("post_id",post.id)
      .eq("user_id",currentUser.id)
      .maybeSingle();

    if(existing){
      await supabase
        .from("likes")
        .update({active:!existing.active})
        .eq("id",existing.id);
    }else{
      await supabase.from("likes").insert({
        post_id:post.id,
        user_id:currentUser.id,
        active:true
      });
    }
  };

  send.onclick=async()=>{
    const value=input.value.trim();
    if(!value) return;

    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:value
    });

    input.value="";
  };

  loadComments(post.id);
}

async function loadComments(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:comments }=await supabase
    .from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});

  const container=postDiv.querySelector(".comments");
  container.innerHTML="";

  comments.forEach(c=>{
    const div=document.createElement("div");
    div.className="comment";
    div.innerText=c.content;
    container.appendChild(div);
  });
}

async function updateLikeUI(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv) return;

  const { data:likes }=await supabase
    .from("likes")
    .select("*")
    .eq("post_id",postId)
    .eq("active",true);

  const likeBtn=postDiv.querySelector(".likeBtn");

  const likeCount=likes.length;
  const likedByMe=likes.some(l=>l.user_id===currentUser.id);

  likeBtn.innerHTML=`‚ù§Ô∏è ${likeCount}`;
  likeBtn.classList.toggle("liked",likedByMe);
}

/* ===== CLEAN REALTIME SYSTEM ===== */

const channel = supabase.channel("db-changes");

channel
.on("postgres_changes",
  {event:"*",schema:"public",table:"posts"},
  payload=>{
    console.log("Post change:",payload);
    loadPosts();
  }
)

.on("postgres_changes",
  {event:"*",schema:"public",table:"likes"},
  payload=>{
    console.log("Like change:",payload);
    updateLikeUI(payload.new?.post_id || payload.old?.post_id);
  }
)

.on("postgres_changes",
  {event:"*",schema:"public",table:"comments"},
  payload=>{
    console.log("Comment change:",payload);
    loadComments(payload.new?.post_id || payload.old?.post_id);
  }
)

.subscribe(status=>{
  console.log("Realtime status:",status);
});

</script>
</body>
</html>