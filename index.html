<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Social App</title>

<style>
:root{
  --bg:#f0f2f5;
  --card:#ffffff;
  --text:#111;
  --primary:#1877f2;
  --danger:#ff4d4f;
  --subtle:#f0f2f5;
  --like:#e0245e;
}
.dark{
  --bg:#18191a;
  --card:#242526;
  --text:#e4e6eb;
  --subtle:#3a3b3c;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:15px;
  transition:.3s;
}
.post{
  background:var(--card);
  padding:15px;
  margin-top:15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
button{
  border:none;
  border-radius:8px;
  padding:6px 12px;
  cursor:pointer;
  margin-top:5px;
}
.primary{background:var(--primary);color:white;}
.danger{background:var(--danger);color:white;}
.likeBtn.liked{background:var(--like);color:white;}

@keyframes pop{
  0%{transform:scale(1);}
  50%{transform:scale(1.4);}
  100%{transform:scale(1);}
}
.likeBtn.animate{
  animation:pop .3s ease;
}

.comment{
  background:var(--subtle);
  padding:6px;
  border-radius:6px;
  margin-top:5px;
  font-size:14px;
}
textarea,input{
  width:100%;
  border-radius:8px;
  padding:6px;
  margin-top:5px;
  background:var(--card);
  color:var(--text);
  border:1px solid #ccc;
}
.actionBar{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}
.badge{
  background:var(--primary);
  color:white;
  padding:2px 6px;
  border-radius:12px;
  font-size:12px;
}
</style>
</head>
<body>

<button id="themeToggle">üåô</button>
<hr>
<h2>üî• Ultimate Social App</h2>

<div id="auth">
  <button id="google" class="primary">Login with Google</button>
  <button id="guest" class="primary">Guest Login</button>
</div>

<div id="app" style="display:none;">
  <p id="user"></p>
  <button id="logout" class="danger">Logout</button>
  <hr>

  <textarea id="text" rows="3" placeholder="Write something..."></textarea>
  <button id="post" class="primary">Post</button>

  <hr>
  <div id="feed"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase=createClient(
  "https://dgehzagvyrxbnnvgsiff.supabase.co",
  "sb_publishable_0zcUZcMnYsVKrX0rhxA9Eg_6GwlyzKW"
);

let currentUser=null;
const feed=document.getElementById("feed");

/* THEME */
const savedTheme=localStorage.getItem("theme");
if(savedTheme){
  if(savedTheme==="dark") document.body.classList.add("dark");
}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){
  document.body.classList.add("dark");
}
updateThemeIcon();

themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",
    document.body.classList.contains("dark")?"dark":"light");
  updateThemeIcon();
};
function updateThemeIcon(){
  themeToggle.innerText=
    document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
}

/* AUTH */
const { data:{ session } }=await supabase.auth.getSession();
if(session){currentUser=session.user;showApp();}
supabase.auth.onAuthStateChange((e,s)=>{
  if(s){currentUser=s.user;showApp();}
});
google.onclick=async()=>{
  await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:window.location.origin}
  });
};
guest.onclick=async()=>{
  await supabase.auth.signInAnonymously();
};
logout.onclick=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

function showApp(){
  auth.style.display="none";
  app.style.display="block";
  user.innerText="Logged in as: "+(currentUser.email||"Guest");
  loadPosts();
}

/* CREATE POST */
post.onclick=async()=>{
  if(!text.value.trim())return;
  await supabase.from("posts").insert({
    content:text.value,
    user_id:currentUser.id
  });
  text.value="";
};

/* LOAD POSTS */
async function loadPosts(){
  feed.innerHTML="";
  const { data:posts }=await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});
  posts.forEach(p=>renderPost(p));
}

/* RENDER POST */
async function renderPost(post){
  if(document.querySelector(`[data-id="${post.id}"]`))return;

  const div=document.createElement("div");
  div.className="post";
  div.dataset.id=post.id;

  div.innerHTML=`
    <div class="content">${post.content}</div>
    <div class="actionBar">
      <button class="likeBtn">‚ù§Ô∏è 0</button>
      <button class="toggleComment">üí¨ <span class="badge">0</span></button>
      ${post.user_id===currentUser.id?
        `<button class="primary editBtn">Edit</button>
         <button class="danger deletePost">Delete</button>`:""}
    </div>
    <div class="commentSection" style="display:none;">
      <div class="comments"></div>
      <input type="text" class="commentInput" placeholder="Write comment...">
      <button class="sendComment primary">Send</button>
    </div>
  `;
  feed.prepend(div);

  const contentDiv=div.querySelector(".content");

  /* EDIT */
  if(div.querySelector(".editBtn")){
    div.querySelector(".editBtn").onclick=()=>{
      const editBox=document.createElement("textarea");
      editBox.value=contentDiv.innerText;
      const save=document.createElement("button");
      save.className="primary";
      save.innerText="Save";
      contentDiv.replaceWith(editBox);
      div.insertBefore(save,div.querySelector(".actionBar"));
      save.onclick=async()=>{
        if(!editBox.value.trim())return;
        await supabase.from("posts")
          .update({content:editBox.value})
          .eq("id",post.id);
        contentDiv.innerText=editBox.value;
        editBox.replaceWith(contentDiv);
        save.remove();
      };
    };
  }

  /* DELETE */
  if(div.querySelector(".deletePost")){
    div.querySelector(".deletePost").onclick=async()=>{
      await supabase.from("posts").delete().eq("id",post.id);
    };
  }

  /* LIKE */
  const likeBtn=div.querySelector(".likeBtn");
  likeBtn.onclick=async()=>{
    const { data:existing }=await supabase
      .from("likes")
      .select("*")
      .eq("post_id",post.id)
      .eq("user_id",currentUser.id)
      .maybeSingle();

    if(existing){
      await supabase.from("likes")
        .update({active:!existing.active})
        .eq("id",existing.id);
    }else{
      await supabase.from("likes").insert({
        post_id:post.id,
        user_id:currentUser.id,
        active:true
      });
    }

    likeBtn.classList.add("animate");
    setTimeout(()=>likeBtn.classList.remove("animate"),300);
  };

  /* COMMENTS */
  div.querySelector(".toggleComment").onclick=()=>{
    const sec=div.querySelector(".commentSection");
    sec.style.display=sec.style.display==="none"?"block":"none";
  };

  div.querySelector(".sendComment").onclick=async()=>{
    const input=div.querySelector(".commentInput");
    if(!input.value.trim())return;
    await supabase.from("comments").insert({
      post_id:post.id,
      user_id:currentUser.id,
      content:input.value
    });
    input.value="";
  };

  updateLikeUI(post.id);
  loadComments(post.id);
}

/* UPDATE LIKE */
async function updateLikeUI(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv)return;
  const { data:likes }=await supabase
    .from("likes")
    .select("*")
    .eq("post_id",postId)
    .eq("active",true);
  const likedByMe=likes.some(l=>l.user_id===currentUser.id);
  const btn=postDiv.querySelector(".likeBtn");
  btn.innerText=`‚ù§Ô∏è ${likes.length}`;
  btn.classList.toggle("liked",likedByMe);
}

/* LOAD COMMENTS */
async function loadComments(postId){
  const postDiv=document.querySelector(`[data-id="${postId}"]`);
  if(!postDiv)return;
  const { data:comments }=await supabase
    .from("comments")
    .select("*")
    .eq("post_id",postId)
    .order("created_at",{ascending:true});
  const container=postDiv.querySelector(".comments");
  container.innerHTML="";
  comments.forEach(c=>{
    const el=document.createElement("div");
    el.className="comment";
    el.innerText=c.content;
    container.appendChild(el);
  });
  postDiv.querySelector(".badge").innerText=comments.length;
}

/* REALTIME */
const channel=supabase.channel("live-feed");
channel
.on("postgres_changes",
  {event:"INSERT",schema:"public",table:"posts"},
  payload=>renderPost(payload.new)
)
.on("postgres_changes",
  {event:"UPDATE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(`[data-id="${payload.new.id}"] .content`);
    if(el)el.innerText=payload.new.content;
  }
)
.on("postgres_changes",
  {event:"DELETE",schema:"public",table:"posts"},
  payload=>{
    const el=document.querySelector(`[data-id="${payload.old.id}"]`);
    if(el)el.remove();
  }
)
.on("postgres_changes",
  {event:"*",schema:"public",table:"likes"},
  payload=>{
    const postId=payload.new?.post_id||payload.old?.post_id;
    if(postId)updateLikeUI(postId);
  }
)
.on("postgres_changes",
  {event:"*",schema:"public",table:"comments"},
  payload=>{
    const postId=payload.new?.post_id||payload.old?.post_id;
    if(postId)loadComments(postId);
  }
)
.subscribe();
</script>
</body>
</html>